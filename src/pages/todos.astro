---
/**
 * Todo Aggregation Page
 * Displays todos from standalone files and inline checkboxes
 * Grouped by area with unchecked first
 */

import DocLayout from '../layouts/DocLayout.astro';
import { getTodos } from '../lib/todos.js';
import { buildNavTree } from '../lib/navigation.js';
import { getCollection } from 'astro:content';

const docs = await getCollection('planning');
const navTree = buildNavTree(docs);
const currentPath = '/todos';
const allTodos = await getTodos();

// Group todos by area
const todosByArea = allTodos.reduce((acc, todo) => {
  const area = todo.area || 'general';
  if (!acc[area]) {
    acc[area] = [];
  }
  acc[area].push(todo);
  return acc;
}, {});

// Sort areas alphabetically, with "general" last
const sortedAreas = Object.keys(todosByArea).sort((a, b) => {
  if (a === 'general') return 1;
  if (b === 'general') return -1;
  return a.localeCompare(b);
});

// Helper: Format source for display
function formatSource(source) {
  if (source === 'standalone') {
    return 'Todo File';
  }
  // Extract plan name from path: phases/06-prettier-rendering/06-01-PLAN.md -> 06-01-PLAN
  const match = source.match(/(\d+-\d+-PLAN)\.md$/);
  return match ? match[1] : source;
}

// Helper: Format area name for display
function formatAreaName(area) {
  return area
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
---

<DocLayout
  headings={[]}
  currentPath={currentPath}
  navTree={navTree}
  title="Todos"
>
  <div class="todos-page">
    <header class="page-header">
      <h1>Project Todos</h1>
      <p class="page-description">
        Tasks and improvements to address
      </p>
    </header>

    {allTodos.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 16 16" aria-hidden="true">
          <rect x="2" y="2" width="12" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
        <h2>No todos found</h2>
        <p>Create todos in <code>.planning/todos/pending/</code> or add checkboxes to PLAN.md files.</p>
      </div>
    ) : (
      <div class="todos-content">
        {sortedAreas.map((area) => (
          <section class="todo-area">
            <h2 class="area-title">{formatAreaName(area)}</h2>
            <ul class="todo-list">
              {todosByArea[area].map((todo) => (
                <li class="todo-item" data-checked={todo.checked}>
                  <span class="todo-check">
                    {todo.checked ? '✓' : '○'}
                  </span>
                  <div class="todo-content">
                    <span class="todo-title">{todo.title}</span>
                    <div class="todo-meta">
                      <span class="todo-source">{formatSource(todo.source)}</span>
                      {todo.created && (
                        <span class="todo-date">
                          <time datetime={todo.created}>{todo.created}</time>
                        </span>
                      )}
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    )}
  </div>
</DocLayout>

<style>
  .todos-page {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--spacing-xl);
  }

  .page-header {
    margin-bottom: var(--spacing-xxl);
  }

  .page-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .page-description {
    margin: 0;
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--spacing-xxl) var(--spacing-lg);
    color: var(--text-secondary);
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: var(--spacing-lg);
    opacity: 0.5;
  }

  .empty-state h2 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-xl);
    color: var(--text-primary);
  }

  .empty-state p {
    margin: 0;
    font-size: var(--font-size-base);
  }

  .empty-state code {
    background-color: var(--bg-secondary);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: var(--font-size-sm);
  }

  /* Todos Content */
  .todos-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
  }

  /* Todo Area Section */
  .todo-area {
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: var(--spacing-lg);
  }

  .area-title {
    margin: 0 0 var(--spacing-md) 0;
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--text-primary);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--border-color);
  }

  /* Todo List */
  .todo-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  /* Todo Item */
  .todo-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background-color: var(--bg-primary);
    border-left: 3px solid var(--border-color);
    border-radius: 4px;
    transition: all var(--transition-fast);
  }

  .todo-item:hover {
    background-color: var(--bg-hover);
  }

  /* Checked vs Unchecked styling */
  .todo-item[data-checked="false"] {
    border-left-color: var(--text-muted);
  }

  .todo-item[data-checked="true"] {
    border-left-color: var(--text-success, #10b981);
    opacity: 0.7;
  }

  .todo-item[data-checked="true"] .todo-title {
    text-decoration: line-through;
    color: var(--text-secondary);
  }

  /* Todo Check Icon */
  .todo-check {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
    font-weight: 700;
    border-radius: 50%;
  }

  .todo-item[data-checked="false"] .todo-check {
    color: var(--text-muted);
  }

  .todo-item[data-checked="true"] .todo-check {
    color: var(--text-success, #10b981);
  }

  /* Todo Content */
  .todo-content {
    flex: 1;
    min-width: 0;
  }

  .todo-title {
    display: block;
    font-size: var(--font-size-base);
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
    line-height: 1.5;
  }

  /* Todo Meta */
  .todo-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  .todo-source {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    font-size: var(--font-size-sm);
    font-weight: 600;
    border-radius: 4px;
    background-color: rgba(59, 130, 246, 0.1);
    color: var(--link-color);
  }

  .todo-date {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
  }

  /* Responsive */
  @media (max-width: 640px) {
    .todos-page {
      padding: var(--spacing-lg);
    }

    .page-header h1 {
      font-size: 2rem;
    }

    .todo-item {
      padding: var(--spacing-sm);
    }

    .todo-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-xs);
    }
  }
</style>
