---
/**
 * Dependency Graph Visualization Page
 * Interactive phase dependency graph using Cytoscape.js
 * Shows which phases block which
 */

import DocLayout from '../layouts/DocLayout.astro';
import { buildDependencyGraph } from '../lib/dependencies.js';
import { buildNavTree } from '../lib/navigation.js';
import { getCollection } from 'astro:content';

const docs = await getCollection('planning');
const navTree = buildNavTree(docs);
const currentPath = '/dependencies';
const graphData = await buildDependencyGraph();
---

<DocLayout
  headings={[]}
  currentPath={currentPath}
  navTree={navTree}
  title="Dependencies"
>
  <div class="dependencies-page">
    <header class="page-header">
      <h1>Phase Dependencies</h1>
      <p class="page-description">
        Which phases block which â€” interactive dependency graph
      </p>
    </header>

    {!graphData || graphData.nodes.length === 0 ? (
      <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 16 16" aria-hidden="true">
          <circle cx="4" cy="4" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="12" cy="4" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="12" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5.5 4.5L6.5 11M10.5 4.5L9.5 11" stroke="currentColor" stroke-width="1"/>
        </svg>
        <h2>No dependencies found</h2>
        <p>Create a ROADMAP.md with phases to see the dependency graph.</p>
      </div>
    ) : (
      <div>
        {graphData.milestones.length > 1 && (
          <div class="milestone-filter">
            <label for="milestone-select">Milestone:</label>
            <select id="milestone-select">
              <option value="all">All Milestones</option>
              {graphData.milestones.map((milestone) => (
                <option value={milestone}>{milestone}</option>
              ))}
            </select>
          </div>
        )}

        <div class="graph-container">
          <div id="cy" class="cytoscape-graph"></div>
          <div class="loading-indicator" id="loading">
            <div class="spinner"></div>
            <p>Loading graph...</p>
          </div>
        </div>

        <div class="legend">
          <h3>Status Legend</h3>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-dot legend-dot--complete"></span>
              <span>Complete</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot legend-dot--active"></span>
              <span>In Progress</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot legend-dot--pending"></span>
              <span>Pending</span>
            </div>
          </div>
          <p class="legend-note">Click any node to navigate to that phase</p>
        </div>
      </div>
    )}
  </div>
</DocLayout>

<style>
  .dependencies-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-xl);
  }

  .page-header {
    margin-bottom: var(--spacing-xl);
  }

  .page-header h1 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .page-description {
    margin: 0;
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--spacing-xxl) var(--spacing-lg);
    color: var(--text-secondary);
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: var(--spacing-lg);
    opacity: 0.5;
  }

  .empty-state h2 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-xl);
    color: var(--text-primary);
  }

  .empty-state p {
    margin: 0;
    font-size: var(--font-size-base);
  }

  /* Milestone Filter */
  .milestone-filter {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background-color: var(--bg-secondary);
    border-radius: 6px;
  }

  .milestone-filter label {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--text-primary);
  }

  .milestone-filter select {
    padding: 6px 12px;
    font-size: var(--font-size-base);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    cursor: pointer;
  }

  /* Graph Container */
  .graph-container {
    position: relative;
    width: 100%;
    min-height: 600px;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
  }

  .cytoscape-graph {
    width: 100%;
    height: 600px;
  }

  .loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: var(--bg-primary);
    z-index: 10;
  }

  .loading-indicator.hidden {
    display: none;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--link-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-indicator p {
    margin-top: var(--spacing-md);
    color: var(--text-secondary);
    font-size: var(--font-size-base);
  }

  /* Legend */
  .legend {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background-color: var(--bg-secondary);
    border-radius: 8px;
  }

  .legend h3 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
  }

  .legend-items {
    display: flex;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .legend-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
  }

  .legend-dot--complete {
    background-color: #10b981;
  }

  .legend-dot--active {
    background-color: #3b82f6;
  }

  .legend-dot--pending {
    background-color: #6b7280;
  }

  .legend-note {
    margin: var(--spacing-md) 0 0 0;
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    font-style: italic;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dependencies-page {
      padding: var(--spacing-lg);
    }

    .page-header h1 {
      font-size: 2rem;
    }

    .graph-container {
      min-height: 400px;
    }

    .cytoscape-graph {
      height: 400px;
    }
  }
</style>

<script define:vars={{ graphData }}>
  // Import Cytoscape and dagre layout
  Promise.all([
    import('cytoscape'),
    import('cytoscape-dagre')
  ]).then(([cytoscapeModule, dagreModule]) => {
    const cytoscape = cytoscapeModule.default;
    const dagre = dagreModule.default;

    // Register dagre extension
    cytoscape.use(dagre);

    // Get container element
    const container = document.getElementById('cy');
    const loadingIndicator = document.getElementById('loading');
    const milestoneSelect = document.getElementById('milestone-select');

    if (!container) {
      console.error('Cytoscape container not found');
      return;
    }

    // Prepare elements for Cytoscape
    const nodes = graphData.nodes.map(n => ({
      data: {
        id: n.id,
        label: n.label,
        status: n.status,
        milestone: n.milestone,
        url: n.url
      }
    }));

    const edges = graphData.edges.map(e => ({
      data: {
        id: `${e.source}-${e.target}`,
        source: e.source,
        target: e.target
      }
    }));

    // Initialize Cytoscape
    const cy = cytoscape({
      container: container,
      elements: {
        nodes: nodes,
        edges: edges
      },
      layout: {
        name: 'dagre',
        rankDir: 'LR',  // Left to right
        nodeSep: 60,
        rankSep: 100,
        padding: 30
      },
      style: [
        // Node styles
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'text-wrap': 'wrap',
            'text-max-width': '150px',
            'font-size': '12px',
            'font-weight': '600',
            'color': '#fff',
            'background-color': '#6b7280',  // Default gray
            'border-width': 2,
            'border-color': '#374151',
            'width': 'label',
            'height': 40,
            'padding': '12px',
            'shape': 'roundrectangle',
            'text-margin-y': 0
          }
        },
        // Complete nodes - green
        {
          selector: 'node[status="complete"]',
          style: {
            'background-color': '#10b981',
            'border-color': '#059669'
          }
        },
        // Active nodes - blue
        {
          selector: 'node[status="active"]',
          style: {
            'background-color': '#3b82f6',
            'border-color': '#2563eb'
          }
        },
        // Pending nodes - gray
        {
          selector: 'node[status="pending"]',
          style: {
            'background-color': '#6b7280',
            'border-color': '#4b5563'
          }
        },
        // Node hover
        {
          selector: 'node:hover',
          style: {
            'border-width': 3,
            'cursor': 'pointer'
          }
        },
        // Edge styles
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#9ca3af',
            'target-arrow-color': '#9ca3af',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'arrow-scale': 1.2
          }
        }
      ],
      minZoom: 0.3,
      maxZoom: 2,
      wheelSensitivity: 0.2
    });

    // Hide loading indicator
    if (loadingIndicator) {
      loadingIndicator.classList.add('hidden');
    }

    // Click handler - navigate to phase page
    cy.on('tap', 'node', (evt) => {
      const node = evt.target;
      const url = node.data('url');
      if (url) {
        window.location.href = url;
      }
    });

    // Milestone filter handler
    if (milestoneSelect) {
      milestoneSelect.addEventListener('change', (e) => {
        const selectedMilestone = e.target.value;

        if (selectedMilestone === 'all') {
          // Show all nodes
          cy.nodes().style('display', 'element');
          cy.edges().style('display', 'element');
        } else {
          // Filter by milestone
          cy.nodes().forEach(node => {
            if (node.data('milestone') === selectedMilestone) {
              node.style('display', 'element');
            } else {
              node.style('display', 'none');
            }
          });

          // Show only edges where both nodes are visible
          cy.edges().forEach(edge => {
            const source = edge.source();
            const target = edge.target();
            if (source.style('display') === 'element' && target.style('display') === 'element') {
              edge.style('display', 'element');
            } else {
              edge.style('display', 'none');
            }
          });
        }

        // Re-run layout for filtered graph
        cy.layout({
          name: 'dagre',
          rankDir: 'LR',
          nodeSep: 60,
          rankSep: 100,
          padding: 30
        }).run();
      });
    }

    // Fit graph to viewport
    cy.fit(30);

  }).catch(error => {
    console.error('Failed to load Cytoscape:', error);
    const loadingIndicator = document.getElementById('loading');
    if (loadingIndicator) {
      loadingIndicator.innerHTML = '<p style="color: red;">Failed to load graph visualization</p>';
    }
  });
</script>
