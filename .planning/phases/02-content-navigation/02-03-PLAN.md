---
phase: 02-content-navigation
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-02
files_modified:
  - src/pages/index.astro
  - src/pages/[...slug].astro
autonomous: true

must_haves:
  truths:
    - "Every .planning markdown file has a generated page"
    - "Homepage shows PROJECT.md or sensible default"
    - "Markdown renders as HTML with syntax highlighting"
    - "Navigation tree shows in sidebar for all pages"
    - "getStaticPaths builds navTree once from all entries and passes to every page via props"
  artifacts:
    - path: "src/pages/[...slug].astro"
      provides: "Dynamic route for all markdown pages"
      exports:
        - getStaticPaths
      contains: "getCollection"
    - path: "src/pages/index.astro"
      provides: "Homepage redirecting to PROJECT.md"
      min_lines: 10
  key_links:
    - from: "src/pages/[...slug].astro"
      to: "src/layouts/DocLayout.astro"
      via: "layout import"
      pattern: "import.*DocLayout"
    - from: "src/pages/[...slug].astro"
      to: "src/lib/navigation.js"
      via: "tree builder import"
      pattern: "import.*buildNavTree"
    - from: "src/pages/[...slug].astro"
      to: "astro:content"
      via: "collection query"
      pattern: "getCollection.*planning"
---

<objective>
Wire content collection to page routes so every markdown file in .planning renders as a navigable HTML page with sidebar and TOC.

Purpose: Complete the content rendering pipeline - users can now browse their docs
Output: Dynamic catch-all route, homepage, working navigation
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-content-navigation/02-RESEARCH.md
@.planning/phases/02-content-navigation/02-01-SUMMARY.md (if exists)
@.planning/phases/02-content-navigation/02-02-SUMMARY.md (if exists)

Key patterns from research:
- Pattern 2: Dynamic Routing with getStaticPaths
- Use getCollection('planning') to get all entries
- Use render(entry) to get { Content, headings }
- Pass headings to DocLayout for TOC generation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic catch-all route</name>
  <files>src/pages/[...slug].astro</files>
  <action>
    Create src/pages/[...slug].astro with:

    1. Imports:
       - getCollection, render from 'astro:content'
       - DocLayout from '../layouts/DocLayout.astro'
       - buildNavTree from '../lib/navigation.js'

    2. getStaticPaths() function:
       - Get all entries: await getCollection('planning')
       - Build navigation tree: buildNavTree(entries)
       - Return array mapping each entry to:
         - params: { slug: entry.id }
         - props: { entry, navTree }

    3. Component script:
       - Get entry and navTree from Astro.props
       - Render entry: const { Content, headings } = await render(entry)
       - Get currentPath from Astro.url.pathname
       - Derive title from entry data or filename

    4. Component template:
       - DocLayout with headings, currentPath, navTree, title props
       - Content component in default slot

    Reference research Pattern 2 for exact getStaticPaths syntax.
  </action>
  <verify>
    Run `npm run dev`.
    Navigate to http://localhost:4321/PROJECT (or similar).
    Page should render with layout and content.
  </verify>
  <done>
    All .planning markdown files accessible via URL paths.
    Content renders with syntax highlighting.
    Navigation tree displayed in sidebar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create homepage with redirect</name>
  <files>src/pages/index.astro</files>
  <action>
    Create src/pages/index.astro with:

    1. Check for PROJECT.md in collection:
       - Import getEntry from 'astro:content'
       - Try to get 'PROJECT' entry

    2. If PROJECT.md exists:
       - Redirect to /PROJECT using Astro.redirect()

    3. If PROJECT.md doesn't exist:
       - Get first entry from collection
       - Redirect to that entry's path

    4. Fallback:
       - If no entries at all, show simple "No .planning folder found" message
       - This handles edge case where .planning exists but is empty
  </action>
  <verify>
    Visit http://localhost:4321/
    Should redirect to /PROJECT or first available doc.
  </verify>
  <done>
    Homepage redirects to PROJECT.md (or first doc).
    Empty .planning folder shows helpful message.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts successfully
2. Visit / - redirects to PROJECT or first doc
3. Visit /PROJECT - renders PROJECT.md content
4. Visit /ROADMAP - renders ROADMAP.md content
5. Visit /phases/01-cli-foundation-dev-server/01-01-PLAN - renders nested file
6. Sidebar shows navigation tree with all files
7. TOC shows headings from current page
8. Internal markdown links work (click from one doc to another)
</verification>

<success_criteria>
- Every markdown file in .planning has a rendered page
- Navigation works between all pages
- Syntax highlighting works for code blocks
- Layout is responsive (test at different widths)
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-navigation/02-03-SUMMARY.md`
</output>
