---
phase: 02-content-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content.config.ts
  - astro.config.mjs
  - src/lib/navigation.js
autonomous: true

must_haves:
  truths:
    - "Content collection loads all .planning markdown files"
    - "Markdown links between .planning files work correctly"
    - "Navigation tree can be built from file paths"
    - "Code blocks have syntax highlighting with Shiki"
  artifacts:
    - path: "src/content.config.ts"
      provides: "Content collection with glob loader for .planning"
      contains: "defineCollection"
    - path: "astro.config.mjs"
      provides: "Rehype plugin for relative markdown links and Shiki syntax highlighting"
      contains: "rehypePlugins"
    - path: "src/lib/navigation.js"
      provides: "Navigation tree builder from collection entries"
      exports:
        - buildNavTree
        - sortGsdItems
  key_links:
    - from: "src/content.config.ts"
      to: ".planning/**/*.md"
      via: "glob loader base path"
      pattern: "base.*\\.planning"
---

<objective>
Configure Astro content collections to discover and process all markdown files in the user's `.planning` folder, with working internal links.

Purpose: Foundation for rendering markdown content - all other plans depend on this
Output: Content collection config, navigation tree builder, rehype plugin for links
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-content-navigation/02-RESEARCH.md

Key patterns from research:
- Use Astro 5.0+ Content Layer API with glob loader
- Install astro-rehype-relative-markdown-links for internal link handling
- Transform entry IDs into nested tree structure for navigation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content collection with glob loader</name>
  <files>src/content.config.ts, astro.config.mjs</files>
  <action>
    1. Install astro-rehype-relative-markdown-links:
       `npm install astro-rehype-relative-markdown-links`

    2. Create src/content.config.ts with:
       - Import defineCollection, z from 'astro:content'
       - Import glob from 'astro/loaders'
       - Define 'planning' collection with glob loader
       - Pattern: "**/*.md"
       - Base: "./.planning" (relative to project root where user runs living-library)
       - Schema: optional title, description fields

    3. Update astro.config.mjs:
       - Import relativeLinks from 'astro-rehype-relative-markdown-links'
       - Add markdown.rehypePlugins: [relativeLinks]
       - Add markdown.shikiConfig with:
         - theme: 'github-light' (light theme only for v1)
         - wrap: true (prevent horizontal scrolling in code blocks)
       - Keep existing minimal config

    Reference research Pattern 1 and Shiki Configuration section for exact syntax.
  </action>
  <verify>
    Run `npm run dev` in the living-library directory.
    Check Astro logs for content collection initialization.
    No errors about content.config.ts.
  </verify>
  <done>
    Content collection 'planning' is registered and loads .planning/*.md files.
    Rehype plugin configured for internal links.
    Shiki syntax highlighting configured with github-light theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build navigation tree utility</name>
  <files>src/lib/navigation.js</files>
  <action>
    Create src/lib/navigation.js with:

    1. buildNavTree(entries) function:
       - Takes array of collection entries (each has .id like "phases/01-foo/01-01-PLAN")
       - Transforms into nested tree structure: { name, path, children }
       - Root files (PROJECT.md, ROADMAP.md, STATE.md, REQUIREMENTS.md) at top
       - Folders become parent nodes with children

    2. sortGsdItems(items) function:
       - GSD folders (phases/, research/, milestones/, todos/) grouped specially
       - Phase folders sorted numerically (01-, 02-, 03-)
       - Other files sorted alphabetically

    3. getDisplayName(id) helper:
       - Convert file ID to human-readable name
       - "phases/01-foundation/01-01-PLAN" -> "01-01-PLAN"
       - "PROJECT" -> "PROJECT.md"

    Use JSDoc for type documentation (consistent with Phase 1 pattern).
  </action>
  <verify>
    Test buildNavTree with mock entries including PROJECT.md, phases/01-foo, research/bar. Verify: (1) PROJECT at root level, (2) phases folder before research, (3) nested structure has name/path/children properties.
  </verify>
  <done>
    Navigation utilities exported and produce correct tree from entry IDs.
    GSD folders sort correctly.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without content collection errors
2. src/content.config.ts exists and exports 'planning' collection
3. src/lib/navigation.js exports buildNavTree and sortGsdItems
4. Internal markdown links will work (verified fully in Plan 03)
</verification>

<success_criteria>
- Content collection configured with glob loader pointing to .planning
- Rehype plugin installed and configured for relative links
- Navigation tree builder ready for sidebar component
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-navigation/02-01-SUMMARY.md`
</output>
