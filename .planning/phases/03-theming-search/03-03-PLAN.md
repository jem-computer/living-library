---
phase: 03-theming-search
plan: 03
type: execute
wave: 2
depends_on:
  - "03-01"
  - "03-02"
files_modified:
  - src/layouts/DocLayout.astro
  - src/components/ThemeToggle.astro
  - astro.config.mjs
autonomous: false

must_haves:
  truths:
    - "Site respects system color scheme preference on first load"
    - "Dark theme toggle in header switches entire site to dark mode"
    - "Theme preference persists across page refreshes"
    - "Search component renders in header with input field"
    - "Pagefind integration is configured for build-time indexing"
    - "Build produces Pagefind index in dist/_pagefind directory"
  artifacts:
    - path: "src/layouts/DocLayout.astro"
      provides: "Theme initialization script and integrated header"
      contains: "is:inline"
    - path: "src/components/ThemeToggle.astro"
      provides: "Theme toggle button component"
      contains: "themeToggle"
    - path: "astro.config.mjs"
      provides: "Pagefind integration"
      contains: "pagefind()"
    - path: "dist/_pagefind"
      provides: "Search index artifacts (post-build)"
      contains: "pagefind.js"
  key_links:
    - from: "src/layouts/DocLayout.astro"
      to: "localStorage"
      via: "inline script"
      pattern: "localStorage.*theme"
    - from: "src/layouts/DocLayout.astro"
      to: "src/components/ThemeToggle.astro"
      via: "import"
      pattern: "import.*ThemeToggle"
    - from: "src/layouts/DocLayout.astro"
      to: "src/components/Search.astro"
      via: "import"
      pattern: "import.*Search"
    - from: "astro.config.mjs"
      to: "astro-pagefind"
      via: "integration"
      pattern: "pagefind\\(\\)"
    - from: "npm run build"
      to: "dist/_pagefind"
      via: "Pagefind post-build step"
      pattern: "_pagefind/pagefind\\.js"
---

<objective>
Wire theme system and search into the layout, completing Phase 3 functionality.

Purpose: Integrates theme initialization (FOUC prevention), theme toggle button, and search component into the document layout. Also adds Pagefind integration to astro.config and marks content areas for search indexing.
Output: Fully functional light/dark theme switching with persistence and working search functionality.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-theming-search/03-RESEARCH.md
@.planning/phases/03-theming-search/03-01-SUMMARY.md
@.planning/phases/03-theming-search/03-02-SUMMARY.md

Key patterns from research:
- Theme init script MUST be is:inline in <head> before body
- Check localStorage first, then matchMedia for system preference
- Pagefind must be LAST integration in array
- data-pagefind-body on main, data-pagefind-ignore on nav/footer/sidebars
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeToggle component</name>
  <files>src/components/ThemeToggle.astro</files>
  <action>
Create the theme toggle button component:

```astro
---
/**
 * Theme Toggle Component
 * Toggles between light and dark themes
 * Icon shows current theme state (sun = light mode active, moon = dark mode active)
 */
---

<button
  id="themeToggle"
  class="theme-toggle"
  aria-label="Toggle dark mode"
  title="Toggle dark mode"
>
  <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
</button>

<style>
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    background: none;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-primary);
    transition: background-color var(--transition-fast), border-color var(--transition-fast);
  }

  .theme-toggle:hover {
    background-color: var(--bg-hover);
  }

  .theme-toggle:focus {
    outline: 2px solid var(--link-color);
    outline-offset: 2px;
  }

  .theme-toggle:focus:not(:focus-visible) {
    outline: none;
  }

  /* Light mode: show sun, hide moon */
  .sun-icon {
    display: block;
  }

  .moon-icon {
    display: none;
  }

  /* Dark mode: show moon, hide sun */
  :global(.dark) .sun-icon {
    display: none;
  }

  :global(.dark) .moon-icon {
    display: block;
  }
</style>

<script>
  const handleToggleClick = () => {
    const element = document.documentElement;
    element.classList.toggle("dark");
    const isDark = element.classList.contains("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  };

  document.getElementById("themeToggle")?.addEventListener("click", handleToggleClick);
</script>
```

Key decisions:
- Sun icon visible in light mode, moon icon visible in dark mode
- Uses optional chaining on getElementById (pitfall #6 from research)
- Stores preference in localStorage
- CSS uses :global(.dark) for class selector from parent
  </action>
  <verify>
Run `cat src/components/ThemeToggle.astro` - should contain themeToggle button with sun/moon SVGs.
  </verify>
  <done>
ThemeToggle.astro component exists with accessible button, icon switching, and click handler that toggles .dark class and persists preference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DocLayout with theme init, components, and content marking</name>
  <files>src/layouts/DocLayout.astro</files>
  <action>
Update DocLayout.astro with:

1. Add imports at the top of the frontmatter:
```astro
import ThemeToggle from '../components/ThemeToggle.astro';
import Search from '../components/Search.astro';
```

2. Add theme initialization script in <head> BEFORE any other scripts or body:
```html
<!-- Theme initialization - prevents FOUC -->
<script is:inline>
  const theme = (() => {
    const stored = localStorage.getItem("theme");
    if (stored === "dark" || stored === "light") {
      return stored;
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "dark") {
    document.documentElement.classList.add("dark");
  } else {
    document.documentElement.classList.remove("dark");
  }

  localStorage.setItem("theme", theme);
</script>
```

3. Update header-content div to include search and theme toggle:
```html
<div class="header-content">
  <button class="mobile-menu-toggle mobile-only" data-menu-toggle aria-label="Toggle navigation menu" aria-expanded="false">
    <span class="hamburger-icon">â˜°</span>
  </button>
  <h1 class="site-title">
    <a href="/">Living Library</a>
  </h1>
  <div class="header-actions">
    <Search />
    <ThemeToggle />
  </div>
</div>
```

4. Add header-actions styles in the <style> section:
```css
.header-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  margin-left: auto;
}

/* Hide search on small mobile, show toggle */
@media (max-width: 480px) {
  .header-actions :global(.search-wrapper) {
    display: none;
  }
}
```

5. Add data-pagefind attributes for search indexing:
- On <header>: add `data-pagefind-ignore`
- On <aside class="sidebar-left">: add `data-pagefind-ignore`
- On <main class="content">: add `data-pagefind-body`
- On <aside class="sidebar-right">: add `data-pagefind-ignore`

Example:
```html
<header class="site-header" data-pagefind-ignore>
<!-- ... -->
<aside class="sidebar-left" data-pagefind-ignore data-sidebar>
<!-- ... -->
<main class="content" data-pagefind-body>
<!-- ... -->
<aside class="sidebar-right" data-pagefind-ignore>
```
  </action>
  <verify>
Run `grep -c "is:inline" src/layouts/DocLayout.astro` - should be >= 1.
Run `grep -c "data-pagefind" src/layouts/DocLayout.astro` - should be >= 4.
Run `grep "ThemeToggle" src/layouts/DocLayout.astro` - should show import and usage.
Run `grep "Search" src/layouts/DocLayout.astro` - should show import and usage.
Start dev server and verify page loads without errors.
  </verify>
  <done>
DocLayout.astro has theme init script preventing FOUC, ThemeToggle and Search in header, and proper data-pagefind attributes on all content sections.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Pagefind integration to astro config and verify build</name>
  <files>astro.config.mjs</files>
  <action>
Update astro.config.mjs to add the Pagefind integration:

1. Add import at top:
```js
import pagefind from 'astro-pagefind';
```

2. Add integrations array with pagefind() LAST:
```js
export default defineConfig({
  integrations: [pagefind()],
  markdown: {
    // existing config...
  }
});
```

Full updated config should look like:
```js
import { defineConfig } from 'astro/config';
import relativeLinks from 'astro-rehype-relative-markdown-links';
import pagefind from 'astro-pagefind';

// This config is used by the dev server
// living-library passes root and server options programmatically
export default defineConfig({
  integrations: [pagefind()],
  markdown: {
    rehypePlugins: [relativeLinks],
    shikiConfig: {
      themes: {
        light: 'github-light',
        dark: 'github-dark',
      },
      wrap: true
    }
  }
});
```

Note: Pagefind integration runs post-build, so search won't work in dev mode. That's expected - search requires a build to generate the index.
  </action>
  <verify>
Run `grep "pagefind" astro.config.mjs` - should show import and usage in integrations array.
Dev server should still start without errors: `npm run dev` (check it starts, then stop).
Run production build to verify Pagefind index generation:
```bash
npm run build && ls -la dist/_pagefind/
```
Should see pagefind.js and other index files in dist/_pagefind/ directory.
  </verify>
  <done>
astro.config.mjs has pagefind integration configured as the last integration in the array. Build produces Pagefind index in dist/_pagefind directory.
  </done>
</task>

</tasks>

<verification>
1. Dev server starts without errors: `npm run dev`
2. Theme toggle button visible in header
3. Clicking toggle switches between light/dark themes
4. Theme persists across page refresh (localStorage)
5. First visit respects system preference (test with browser dark mode)
6. Code blocks switch colors with theme (Shiki dual themes)
7. Search input visible in header
8. No FOUC on page load (theme applied before paint)
9. Production build generates Pagefind index: `npm run build && ls dist/_pagefind/`
</verification>

<success_criteria>
- Theme initialization prevents FOUC
- Theme toggle works and persists preference
- System preference respected on first visit
- Search component renders in header
- Content properly marked for Pagefind indexing
- Build produces Pagefind index in dist/_pagefind/
- All Phase 3 requirements (THEME-01, THEME-02, THEME-03, SRCH-01, SRCH-02, SRCH-03) addressed
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete theme switching system and search integration</what-built>
  <how-to-verify>
**Part A: Dev mode verification (theming)**
1. Start dev server: `npm run dev`
2. Visit http://localhost:4321
3. Verify light theme is default (white background)
4. Click theme toggle - should switch to dark theme (dark background)
5. Refresh page - dark theme should persist
6. Clear localStorage and set system to dark mode - page should load in dark mode
7. Verify code blocks switch themes correctly

**Part B: Build verification (search - REQUIRED)**
8. Stop dev server
9. Run: `npm run build`
10. Verify Pagefind index exists: `ls dist/_pagefind/` should show pagefind.js
11. Serve built site: `npx serve dist`
12. Visit http://localhost:3000
13. Verify search box appears in header
14. Type a search query - should show live results from indexed content
  </how-to-verify>
  <resume-signal>Type "approved" if both theming AND search work correctly, or describe any issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/03-theming-search/03-03-SUMMARY.md`
</output>
