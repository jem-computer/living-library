---
phase: 04-static-build-gsd-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli.js
  - src/build.js
autonomous: true

must_haves:
  truths:
    - "User runs `npx living-library build` and static site outputs to ./dist"
    - "Build produces deployment-ready HTML/CSS/JS with no server dependencies"
    - "Build shows minimal success message: 'Build complete: ./dist'"
  artifacts:
    - path: "src/build.js"
      provides: "Programmatic Astro build wrapper"
      exports: ["runBuild"]
    - path: "src/cli.js"
      provides: "Subcommand routing (dev vs build)"
      contains: "positionals[0]"
  key_links:
    - from: "src/cli.js"
      to: "src/build.js"
      via: "import and call runBuild"
      pattern: "import.*runBuild.*build\\.js"
---

<objective>
Add `build` subcommand to CLI that generates static site to `./dist`.

Purpose: Users need to deploy production sites without running a dev server. The build command outputs deployment-ready HTML/CSS/JS.

Output: Working `npx living-library build` command that produces static site in ./dist directory.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-static-build-gsd-features/04-RESEARCH.md

Reference existing patterns:
@src/cli.js — Current CLI structure with parseArgs
@src/dev-server.js — Pattern for Astro programmatic API (dev() call)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build.js module</name>
  <files>src/build.js</files>
  <action>
Create build.js following the dev-server.js pattern:

1. Import `build` from 'astro' (not dev)
2. Import path from 'node:path'
3. Import colors from './ui/colors.js'

4. Create async function `runBuild({ root, output = './dist', verbose = false })`:
   - Call `await build({ root: path.resolve(root), outDir: output, logLevel: verbose ? 'debug' : 'warn' })`
   - On success: `console.log(colors.success(\`Build complete: ${output}\`))`
   - On error: Log error message with colors.error, exit with code 1
   - If verbose, also log error.stack

5. Export runBuild

Use colors.success for the success message (it should exist in ui/colors.js, if not use colors.green).
  </action>
  <verify>File exists at src/build.js with runBuild export</verify>
  <done>build.js exports runBuild function that calls Astro's build() API</done>
</task>

<task type="auto">
  <name>Task 2: Update CLI for subcommand routing</name>
  <files>src/cli.js</files>
  <action>
Update cli.js to detect 'build' subcommand:

1. Add import: `import { runBuild } from './build.js';`

2. In parseArgs call, ensure `allowPositionals: true` is set (already present) and extract positionals:
   ```javascript
   const { values, positionals } = parseArgs({...})
   ```

3. After help/version handling, determine command:
   ```javascript
   const command = positionals[0] || 'dev';
   ```

4. Add command routing:
   ```javascript
   if (command === 'build') {
     await runBuild({
       root: detected.path,
       verbose: values.verbose
     });
     return;
   } else if (command === 'dev' || command === undefined) {
     await startDev(values.verbose);
   } else {
     console.error(colors.error(`Unknown command: ${command}`));
     process.exit(1);
   }
   ```

5. Move the .planning detection BEFORE command routing (it's needed by both dev and build).

6. Update help text to show build command:
   ```
   Usage:
     npx living-library [command] [options]

   Commands:
     dev     Start development server (default)
     build   Generate static site to ./dist

   Options:
     -v, --verbose  Show detailed output
     -h, --help     Show this help message
     --version      Show version number
   ```
  </action>
  <verify>`node bin/living-library.js --help` shows build command in usage</verify>
  <done>CLI routes 'build' to runBuild and 'dev' (or no command) to startDev</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end build verification</name>
  <files>None (verification only)</files>
  <action>
Verify the build command works end-to-end:

1. Run from the living-library project root (which has .planning):
   ```bash
   node bin/living-library.js build
   ```

2. Verify:
   - Command completes without error
   - "./dist" folder is created
   - dist/ contains HTML files (at minimum index.html)
   - Success message "Build complete: ./dist" appears

3. Clean up dist/ after verification:
   ```bash
   rm -rf dist
   ```

If build fails, check error message and fix. Common issues:
- Astro config not found: Ensure astro.config.mjs is present at project root
- Content collection issues: Check that glob paths resolve correctly
  </action>
  <verify>dist/ folder created with HTML files, success message printed</verify>
  <done>`npx living-library build` produces working static site in ./dist</done>
</task>

</tasks>

<verification>
1. `node bin/living-library.js --help` shows both dev and build commands
2. `node bin/living-library.js build` outputs "Build complete: ./dist"
3. dist/ folder contains index.html and other HTML files
4. dist/ contains no node_modules or server-side code (static assets only)
</verification>

<success_criteria>
- `npx living-library build` works from project root
- Static site in ./dist is deployment-ready (HTML/CSS/JS, no server)
- Build command shows minimal success message
- Help text documents build command
</success_criteria>

<output>
After completion, create `.planning/phases/04-static-build-gsd-features/04-01-SUMMARY.md`
</output>
