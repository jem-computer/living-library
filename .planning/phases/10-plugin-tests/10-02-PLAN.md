---
phase: 10-plugin-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/plugins/rehype-gsd-blocks.test.ts
autonomous: true

must_haves:
  truths:
    - "rehypeGsdBlocks wraps <objective> with styled container and header"
    - "rehypeGsdBlocks converts <execution-context> to collapsible details/summary"
    - "rehypeGsdBlocks handles <task> blocks with name attribute"
    - "rehypeGsdBlocks normalizes underscores to hyphens in tag names"
    - "Tests run against HTML strings via rehype processor, not Astro builds"
  artifacts:
    - path: "test/unit/plugins/rehype-gsd-blocks.test.ts"
      provides: "Unit tests for rehypeGsdBlocks transformations"
      min_lines: 100
  key_links:
    - from: "test/unit/plugins/rehype-gsd-blocks.test.ts"
      to: "src/plugins/rehype-gsd-blocks.js"
      via: "import rehypeGsdBlocks"
      pattern: "import.*rehypeGsdBlocks.*from"
---

<objective>
Unit tests for rehype plugin: rehypeGsdBlocks

Purpose: Verify rehypeGsdBlocks correctly wraps GSD XML tags with styled HTML containers, handles collapsible blocks, and processes task attributes
Output: Comprehensive test file covering all 9 tag types, collapsible behavior, and edge cases
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-plugin-tests/10-RESEARCH.md
@src/plugins/rehype-gsd-blocks.js
@test/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rehypeGsdBlocks tests for non-collapsible blocks</name>
  <files>test/unit/plugins/rehype-gsd-blocks.test.ts</files>
  <action>
Create `test/unit/plugins/rehype-gsd-blocks.test.ts` with tests covering non-collapsible blocks.

**Setup:** Use `unified().use(rehypeParse, { fragment: true }).use(rehypeGsdBlocks).use(rehypeStringify).processSync(input)` pattern from RESEARCH.md.

**Non-collapsible blocks with headers (objective, process, success-criteria, context, tasks, verification, output):**
- `<objective>content</objective>` produces:
  - Container with `class="gsd-block gsd-objective"`
  - Data attribute `data-gsd-type="objective"`
  - Header div with `class="gsd-header"` containing "Objective"
- Same pattern for: process, success-criteria, context, tasks, verification, output
- Each gets appropriate title: "Process", "Success Criteria", "Context", "Tasks", "Verification", "Output"

**Task blocks (special handling):**
- `<task>content</task>` produces container with `class="gsd-block gsd-task"` but NO header
- `<task name="Setup tests">content</task>` produces:
  - Container with `class="gsd-block gsd-task"`
  - Task header div with `class="gsd-task-header"` containing "Setup tests"
- `<task type="auto">content</task>` adds `class="gsd-task-auto"` to container

**Test structure:** Group tests by tag type using describe blocks.
  </action>
  <verify>Run `npm test -- test/unit/plugins/rehype-gsd-blocks.test.ts` - non-collapsible tests pass</verify>
  <done>Non-collapsible block tests pass for all 8 tag types (objective, process, success-criteria, context, tasks, task, verification, output)</done>
</task>

<task type="auto">
  <name>Task 2: Add collapsible blocks and edge case tests</name>
  <files>test/unit/plugins/rehype-gsd-blocks.test.ts</files>
  <action>
Add tests to `test/unit/plugins/rehype-gsd-blocks.test.ts` covering:

**Collapsible blocks (execution-context):**
- `<execution-context>content</execution-context>` produces:
  - `<details class="gsd-collapsible">` wrapper
  - `<summary class="gsd-summary">Execution Context</summary>` element
  - `<div class="gsd-content">content</div>` for body
  - NO `open` attribute (defaults closed per config)

**Underscore normalization:**
- `<execution_context>content</execution_context>` normalizes to `execution-context` in output
- `<success_criteria>content</success_criteria>` normalizes to `success-criteria`
- Data attribute shows normalized name: `data-gsd-type="execution-context"`

**Edge cases:**
- Unknown tags are NOT transformed (pass through unchanged)
- Nested GSD tags: `<tasks><task>content</task></tasks>` both transform correctly
- Empty content: `<objective></objective>` still gets header
- Content with HTML: `<objective><strong>bold</strong> text</objective>` preserves inner HTML
- Multiple GSD blocks in same input all transform
- GSD block inside another element: `<div><objective>content</objective></div>` transforms the objective

**Non-GSD passthrough:**
- `<div>content</div>` passes through unchanged
- `<custom-tag>content</custom-tag>` passes through unchanged
  </action>
  <verify>Run `npm test -- test/unit/plugins/rehype-gsd-blocks.test.ts` - all tests pass</verify>
  <done>rehypeGsdBlocks has complete test coverage for collapsible blocks, underscore normalization, and edge cases</done>
</task>

</tasks>

<verification>
```bash
# Run rehype plugin tests
npm test -- test/unit/plugins/rehype-gsd-blocks.test.ts

# Check coverage for rehype plugin specifically
npm run coverage -- --reporter=text test/unit/plugins/rehype-gsd-blocks.test.ts
```

Expected: All tests pass, coverage shows rehype-gsd-blocks.js is tested.
</verification>

<success_criteria>
1. `test/unit/plugins/rehype-gsd-blocks.test.ts` exists with 15+ test cases
2. All 9 GSD tag types are tested (objective, process, execution-context, success-criteria, context, tasks, task, verification, output)
3. Collapsible behavior tested for execution-context
4. Task name and type attributes tested
5. Underscore normalization tested
6. All tests pass with explicit assertions (no snapshots)
7. Tests process HTML strings through rehype pipeline (not Astro builds)
</success_criteria>

<output>
After completion, create `.planning/phases/10-plugin-tests/10-02-SUMMARY.md`
</output>
