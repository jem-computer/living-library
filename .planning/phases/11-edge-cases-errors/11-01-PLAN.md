---
phase: 11-edge-cases-errors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/milestones.js
  - src/lib/dependencies.js
  - src/lib/navigation.js
  - src/lib/todos.js
  - test/unit/lib/milestones.test.ts
  - test/unit/lib/dependencies.test.ts
  - test/unit/lib/navigation.test.ts
  - test/unit/lib/todos.test.ts
autonomous: true

must_haves:
  truths:
    - "Empty ROADMAP.md returns empty milestones array, never throws"
    - "Phase header without checkbox still extracts phase name and number"
    - "Unusual checkbox formats (tabs, extra spaces, [X], missing dash) still parse or degrade gracefully"
    - "Empty .planning folder (no entries) renders without crash"
    - "Parsers never throw exceptions to callers — all functions catch internally"
    - "Partial parse success works — if 3 of 5 phases parse, return those 3"
  artifacts:
    - path: "src/lib/milestones.js"
      provides: "Defensive milestone parsing with try-catch and best-effort extraction"
    - path: "src/lib/dependencies.js"
      provides: "Defensive dependency parsing, silently drops invalid phase refs"
    - path: "src/lib/navigation.js"
      provides: "Handles empty entries, null paths, malformed IDs"
    - path: "src/lib/todos.js"
      provides: "Handles missing frontmatter, empty plan bodies"
    - path: "test/unit/lib/milestones.test.ts"
      provides: "Edge case tests for malformed milestone input"
    - path: "test/unit/lib/dependencies.test.ts"
      provides: "Edge case tests for malformed dependency input"
    - path: "test/unit/lib/navigation.test.ts"
      provides: "Edge case tests for empty/malformed nav entries"
    - path: "test/unit/lib/todos.test.ts"
      provides: "Edge case tests for missing frontmatter and empty plans"
  key_links:
    - from: "test/unit/lib/milestones.test.ts"
      to: "src/lib/milestones.js"
      via: "import and edge case assertions"
      pattern: "expect.*not.*toThrow|toEqual.*\\[\\]"
---

<objective>
Harden all four parsing modules (milestones.js, dependencies.js, navigation.js, todos.js) so that malformed, empty, or unexpected `.planning` input produces graceful degradation — never crashes. Add edge case tests proving each parser handles bad input.

Purpose: The `.planning` content is non-deterministic markdown from agentic tools. Parsers must render what they can and silently skip what they cannot. This is the final phase of v1.2 Testing & Robustness.

Output: Updated parser modules with defensive coding + new edge case test suites proving graceful degradation.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-edge-cases-errors/11-CONTEXT.md
@.planning/phases/11-edge-cases-errors/11-RESEARCH.md
@src/lib/milestones.js
@src/lib/dependencies.js
@src/lib/navigation.js
@src/lib/todos.js
@test/unit/lib/milestones.test.ts
@test/unit/lib/dependencies.test.ts
@test/unit/lib/navigation.test.ts
@test/unit/lib/todos.test.ts
@test/setup.ts
@test/fixtures/roadmap-samples.ts
@test/fixtures/todo-samples.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add defensive edge case handling to all four parsers</name>
  <files>
    src/lib/milestones.js
    src/lib/dependencies.js
    src/lib/navigation.js
    src/lib/todos.js
  </files>
  <action>
    Harden each parser with graceful degradation. The philosophy: render what you can, never crash, silently handle weirdness. No user-facing error messages. No `{ result, warnings }` pattern. Just best-effort results.

    **milestones.js:**
    - Wrap `parsePhases` body in try-catch — return empty array on failure
    - Wrap `parseMilestoneHeader` in try-catch — return default values on failure
    - Handle `body` being null/undefined (not just empty string) — treat as empty string
    - In `parsePhases`, if a phase header regex matches but `parseInt` produces NaN, skip that phase silently
    - Accept `[X]` (uppercase) as complete in legacy checkbox format (the regex currently only matches lowercase `x`)
    - Handle phase header without any content after it (last phase in file with no trailing newline)
    - Wrap `getCurrentMilestone` body processing in try-catch so one bad parse doesn't prevent returning other milestones

    **dependencies.js:**
    - Wrap `parsePhases` body in try-catch — return `{ nodes: [], edges: [] }` on failure
    - After building all edges, filter out any edge where source or target node ID doesn't exist in the nodes array (silently drop references to non-existent phases)
    - Handle `body` being null/undefined — treat as empty string
    - Handle `milestone` parameter being null/undefined — default to 'v1.0'

    **navigation.js:**
    - In `buildNavTree`, handle `entries` being null/undefined/not-an-array — return array with just GSD section
    - In `sortGsdItems`, guard against items with null/undefined `path` — place them last
    - In `buildNavTree`, skip entries with empty or null `id` property
    - Handle entries where `id.split('/')` produces unexpected results (empty segments)

    **todos.js:**
    - Handle plan files where `doc.body` is null/undefined/empty — skip without error
    - Handle standalone todos where frontmatter fields (`title`, `area`, `created`) are completely missing — use fallback values ('Untitled Todo', 'general', null)
    - In `extractTextFromNode`, handle nodes with unexpected structure (no value, no children) — return empty string (already does this, but verify)
    - In `deriveAreaFromPath`, handle paths that don't match the expected pattern — already returns 'general', just ensure no throw

    **Important:** Do NOT add console.warn/console.error for recoverable issues. Silent degradation. The existing console.warn calls in catch blocks (e.g., getArchivedMilestones, getStandaloneTodos, getInlineTodos) can remain since they only fire on actual exceptions, but do not add new ones for expected edge cases.
  </action>
  <verify>
    Run `npm test` — all existing tests still pass (no regressions). Review each file to confirm try-catch wrapping is in place.
  </verify>
  <done>
    All four parser modules have defensive try-catch wrapping around regex operations, null/undefined input guards, and best-effort extraction. No function throws to its caller. Existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edge case test suites to all four parser test files</name>
  <files>
    test/unit/lib/milestones.test.ts
    test/unit/lib/dependencies.test.ts
    test/unit/lib/navigation.test.ts
    test/unit/lib/todos.test.ts
  </files>
  <action>
    Add a dedicated `describe('edge cases')` block (or extend the existing one) in each test file. Tests should prove that bad input produces reasonable output, not crashes.

    **milestones.test.ts** — add/extend edge case tests:
    1. `should handle null body from getEntry` — mock getEntry returning entry with null body → returns empty milestones
    2. `should handle ROADMAP.md with only whitespace` — body is `"   \n\n  "` → returns empty milestones
    3. `should handle phase header without colon separator` — `### Phase 1 Setup` (missing colon) → skipped, no crash
    4. `should handle extremely long phase names` — 500-char name → parses without error
    5. `should handle [X] (uppercase) in legacy checkbox format` — `- [X] **Phase 1: Done** - desc` → parsed as complete
    6. `should handle malformed milestone header` — body has `# Not a milestone format` → uses fallback version/name
    7. `should handle getCollection throwing error` — mock getCollection to reject → returns current milestone only, no throw

    **dependencies.test.ts** — add/extend edge case tests:
    1. `should handle null body from roadmap entry` — entry with null body → empty graph
    2. `should silently drop edges referencing non-existent phases` — Phase 3 depends on Phase 99 (which doesn't exist) → edge is dropped, nodes still present
    3. `should handle phase with no depends_on line` — phases without dependency declarations → nodes created, no edges
    4. `should handle roadmap with only headers, no phase content` — `### Phase 1: Name\n### Phase 2: Name` → nodes created with default values
    5. `should handle getCollection throwing error` — mock getCollection to reject → returns current roadmap data only

    **navigation.test.ts** — add/extend edge case tests:
    1. `should handle empty entries array` — `buildNavTree([])` → returns array with GSD section only
    2. `should handle entries with empty id` — entry with `id: ''` → skipped, no crash
    3. `should handle null entries parameter` — `buildNavTree(null)` → returns array with GSD section only
    4. `should handle entries with deeply nested paths` — `a/b/c/d/e/file` → builds nested tree without error
    5. `should handle sortGsdItems with items missing path` — item with `path: null` → sorted last, no crash

    **todos.test.ts** — add/extend edge case tests:
    1. `should handle plan file with empty body` — plan entry with body `""` → returns empty todos from that file
    2. `should handle plan file with null body` — plan entry with body `null` → no crash, skipped
    3. `should handle standalone todo with no frontmatter fields` — entry with `data: {}` → uses fallback title 'Untitled Todo', area 'general'
    4. `should handle getCollection throwing for standalone todos` — mock getCollection to throw → returns empty array
    5. `should handle plan file with markdown but no checkboxes` — body with headings/paragraphs but no `- [ ]` items → returns empty array for that file

    Each test: mock the appropriate astro:content functions, call the parser, assert it returns a reasonable result (empty array, partial data, fallback values) without throwing.
  </action>
  <verify>
    Run `npm test` — all tests pass including new edge case tests. Run `npm test -- --coverage` to verify coverage improved or maintained.
  </verify>
  <done>
    Each parser test file has comprehensive edge case tests covering: null/undefined input, empty input, malformed formats, partial data, and error recovery. All tests pass. No parser function throws on bad input.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with zero failures
2. `npm test -- --coverage` shows maintained or improved coverage for all four parser modules
3. No parser function throws an exception when given malformed input
4. Existing test suites have zero regressions
5. Edge case tests specifically verify: empty ROADMAP.md, malformed headers, missing frontmatter, empty entries array, null body content
</verification>

<success_criteria>
- All existing tests pass (zero regressions)
- 20+ new edge case tests added across the four parser test files
- Every parser function handles null/undefined/empty/malformed input without throwing
- Dependencies graph silently drops references to non-existent phases
- Navigation tree handles empty entries gracefully
- Coverage maintained or improved across all parser modules
</success_criteria>

<output>
After completion, create `.planning/phases/11-edge-cases-errors/11-01-SUMMARY.md`
</output>
