---
phase: 11-edge-cases-errors
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/remark-gsd-links.js
  - src/plugins/rehype-gsd-blocks.js
  - src/plugins/remark-normalize-gsd-tags.js
  - test/unit/plugins/remark-gsd-links.test.ts
  - test/unit/plugins/rehype-gsd-blocks.test.ts
  - test/unit/plugins/remark-normalize-gsd-tags.test.ts
autonomous: true

must_haves:
  truths:
    - "Plugins pass through content they cannot transform — user sees raw text, not nothing"
    - "Plugins never throw exceptions — malformed AST nodes are skipped silently"
    - "Empty trees processed without error"
    - "Unexpected node types or missing properties do not crash plugins"
    - "Build never fails because of bad .planning content passing through plugins"
  artifacts:
    - path: "src/plugins/remark-gsd-links.js"
      provides: "Defensive link transformation, passes through unparseable @refs"
    - path: "src/plugins/rehype-gsd-blocks.js"
      provides: "Defensive block styling, skips malformed elements"
    - path: "src/plugins/remark-normalize-gsd-tags.js"
      provides: "Defensive tag normalization, passes through unrecognized content"
    - path: "test/unit/plugins/remark-gsd-links.test.ts"
      provides: "Edge case tests for link plugin"
    - path: "test/unit/plugins/rehype-gsd-blocks.test.ts"
      provides: "Edge case tests for block plugin"
    - path: "test/unit/plugins/remark-normalize-gsd-tags.test.ts"
      provides: "Edge case tests for tag normalization plugin"
  key_links:
    - from: "test/unit/plugins/remark-gsd-links.test.ts"
      to: "src/plugins/remark-gsd-links.js"
      via: "import and edge case assertions"
      pattern: "expect.*not.*toThrow"
---

<objective>
Harden all three plugins (remarkGsdLinks, rehypeGsdBlocks, remarkNormalizeGsdTags) so that malformed AST nodes, empty trees, or unexpected content passes through unchanged rather than crashing. Add edge case tests proving each plugin handles bad input.

Purpose: Plugins process markdown from non-deterministic agentic tools. They must transform what they recognize and silently pass through everything else. No build should ever fail because of bad `.planning` content.

Output: Updated plugin modules with defensive coding + new edge case test suites proving graceful degradation.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-edge-cases-errors/11-CONTEXT.md
@.planning/phases/11-edge-cases-errors/11-RESEARCH.md
@src/plugins/remark-gsd-links.js
@src/plugins/rehype-gsd-blocks.js
@src/plugins/remark-normalize-gsd-tags.js
@test/unit/plugins/remark-gsd-links.test.ts
@test/unit/plugins/rehype-gsd-blocks.test.ts
@test/unit/plugins/remark-normalize-gsd-tags.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add defensive edge case handling to all three plugins</name>
  <files>
    src/plugins/remark-gsd-links.js
    src/plugins/rehype-gsd-blocks.js
    src/plugins/remark-normalize-gsd-tags.js
  </files>
  <action>
    Harden each plugin with graceful degradation. Philosophy: transform what you recognize, pass through everything else unchanged. Never crash.

    **remark-gsd-links.js:**
    - Wrap the entire `findAndReplace` call in a try-catch — if it throws (e.g., malformed tree), return the tree unchanged
    - In the internal planning link handler, guard against `path` being undefined/null — return the original match text as a plain text node if path is falsy
    - In the external ref handler, guard against `match` being undefined — return original text
    - Handle the case where tree is null/undefined — return early without processing

    **rehype-gsd-blocks.js:**
    - Wrap each `visit` pass in try-catch — if first pass throws, skip to second pass; if second throws, return tree unchanged
    - Guard against node.properties being null when accessing className, type, name — use optional chaining and defaults
    - Guard against node.children being null/undefined when creating collapsible blocks — default to empty array
    - Handle the case where tree is null/undefined — return early without processing
    - When `Object.assign(node, details)` runs for collapsible, guard against details being malformed

    **remark-normalize-gsd-tags.js:**
    - Wrap each `visit` pass in try-catch — if first pass throws, skip to second; if second throws, return tree unchanged
    - Guard against `node.children[0]` not existing or not having `.value` — check before accessing
    - Guard against `parent.children[index]` being out of bounds — verify index is valid
    - Guard against `node.value` being null/undefined in the html visitor — skip node if no value
    - Handle the case where tree is null/undefined — return early without processing

    **Important:** Do NOT add console.warn/console.error for edge cases. Silent pass-through. If a plugin can't transform something, the user sees the raw text — that's fine.
  </action>
  <verify>
    Run `npm test` — all existing plugin tests still pass (no regressions).
  </verify>
  <done>
    All three plugins have defensive try-catch wrapping and null guards. No plugin throws to its caller. Unrecognized or malformed content passes through unchanged. Existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add edge case test suites to all three plugin test files</name>
  <files>
    test/unit/plugins/remark-gsd-links.test.ts
    test/unit/plugins/rehype-gsd-blocks.test.ts
    test/unit/plugins/remark-normalize-gsd-tags.test.ts
  </files>
  <action>
    Add a dedicated `describe('edge cases')` block in each test file. Tests should prove that bad input produces unchanged output, not crashes.

    **remark-gsd-links.test.ts** — add edge case tests:
    1. `should handle empty markdown` — process `""` → no error, empty output
    2. `should pass through @ not followed by a path` — `"Email me at user@example.com"` → text preserved, not transformed into a link
    3. `should handle markdown with only whitespace` — `"   \n\n  "` → no error
    4. `should handle @ at end of line` — `"Contact @"` → no crash, text preserved
    5. `should handle deeply nested markdown with @refs` — @ref inside blockquote inside list → still transforms correctly or passes through

    **rehype-gsd-blocks.test.ts** — add edge case tests:
    1. `should handle empty HTML input` — process `""` → no error
    2. `should pass through unknown HTML elements unchanged` — `<custom-element>content</custom-element>` → unchanged
    3. `should handle GSD element with no children` — `<objective></objective>` → wraps with header, empty body, no crash
    4. `should handle element with null properties` — programmatically create element node with `properties: null` → no crash
    5. `should handle deeply nested GSD blocks` — `<tasks><task><objective>...</objective></task></tasks>` → transforms all levels

    **remark-normalize-gsd-tags.test.ts** — add edge case tests:
    1. `should handle empty markdown` — process `""` → no error, empty output
    2. `should handle paragraph with multiple children (not just text)` — paragraph with link + text → not converted (existing behavior), no crash
    3. `should handle text node with empty value` — paragraph containing text node with `value: ""` → no crash
    4. `should pass through non-GSD angle brackets` — `"<div>regular html</div>"` → unchanged
    5. `should handle markdown with only GSD closing tags` — `"</objective>"` → passes through unchanged, no crash

    Each test: create markdown/HTML input, run through the unified pipeline with the plugin, assert output is either correctly transformed or unchanged (never an error).

    Use the same test patterns established in Phase 10 — unified + remark-parse + remark-stringify for remark plugins, unified + rehype-parse + rehype-stringify for rehype plugins.
  </action>
  <verify>
    Run `npm test` — all tests pass including new edge case tests. Run `npm test -- --coverage` to verify coverage improved or maintained.
  </verify>
  <done>
    Each plugin test file has comprehensive edge case tests covering: empty input, malformed elements, unrecognized tags, null properties, and unexpected nesting. All tests pass. No plugin throws on bad input.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with zero failures
2. `npm test -- --coverage` shows maintained or improved coverage for all three plugin modules
3. No plugin throws an exception when given malformed input
4. Existing plugin test suites have zero regressions
5. Edge case tests specifically verify: empty input, unknown elements, null properties, missing children, deeply nested structures
</verification>

<success_criteria>
- All existing tests pass (zero regressions)
- 15+ new edge case tests added across the three plugin test files
- Every plugin handles null/undefined/empty/malformed AST nodes without throwing
- Unrecognized content passes through unchanged
- Coverage maintained or improved across all plugin modules
</success_criteria>

<output>
After completion, create `.planning/phases/11-edge-cases-errors/11-02-SUMMARY.md`
</output>
