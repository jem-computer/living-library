---
phase: 09-parsing-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/lib/todos.test.ts
  - test/fixtures/todo-samples.ts
autonomous: true

must_haves:
  truths:
    - "getTodos correctly extracts inline and standalone todos"
    - "getInlineTodos parses checkboxes from PLAN.md files"
    - "getStandaloneTodos reads from todos/pending/*.md"
    - "deriveAreaFromPath extracts phase name from path"
  artifacts:
    - path: "test/unit/lib/todos.test.ts"
      provides: "Comprehensive tests for todo extraction"
      min_lines: 120
    - path: "test/fixtures/todo-samples.ts"
      provides: "Reusable todo fixture builders"
      exports: ["createPlanWithTodos", "createStandaloneTodo"]
  key_links:
    - from: "test/unit/lib/todos.test.ts"
      to: "src/lib/todos.js"
      via: "dynamic import after vi.mock"
      pattern: "await import\\(.*todos\\.js"
---

<objective>
Create comprehensive tests for todo extraction from standalone files and inline checkboxes.

Purpose: Requirement PARSE-02 - Unit tests for getTodos, getInlineTodos, getStandaloneTodos
Output: todos.test.ts with 10+ test cases covering all extraction paths
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-parsing-tests/09-RESEARCH.md

# Phase 8 patterns
@test/setup.ts
@src/lib/todos.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create todo fixture builders</name>
  <files>test/fixtures/todo-samples.ts</files>
  <action>
Create fixture builder functions for todo test data:

```typescript
// test/fixtures/todo-samples.ts
import { mockContentEntry } from '../setup.js';

/**
 * Create a PLAN.md fixture with checkbox todos
 */
export function createPlanWithTodos(options: {
  phase: string;  // e.g., "06-prettier-rendering"
  plan: string;   // e.g., "01"
  todos: Array<{
    text: string;
    checked: boolean;
  }>;
}): ReturnType<typeof mockContentEntry> {
  const { phase, plan, todos } = options;
  const id = `phases/${phase}/${phase.split('-')[0]}-${plan}-PLAN`;

  const todoLines = todos.map(t =>
    `- [${t.checked ? 'x' : ' '}] ${t.text}`
  ).join('\n');

  const body = `## Tasks\n\n${todoLines}`;

  return mockContentEntry(id, body);
}

/**
 * Create a standalone todo file fixture
 */
export function createStandaloneTodo(options: {
  filename: string;  // e.g., "2026-01-27-test-todo"
  title: string;
  area?: string;
  created?: string;
}): ReturnType<typeof mockContentEntry> {
  const { filename, title, area = 'general', created = '2026-01-27T10:00:00Z' } = options;
  const id = `todos/pending/${filename}`;

  return mockContentEntry(id, '', {
    title,
    area,
    created
  });
}

/**
 * Create a path string for testing deriveAreaFromPath
 */
export function createPhasePath(phaseNum: number, phaseName: string, planNum: string): string {
  const padded = String(phaseNum).padStart(2, '0');
  return `phases/${padded}-${phaseName}/${padded}-${planNum}-PLAN.md`;
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit test/fixtures/todo-samples.ts`</verify>
  <done>Fixture builders exist with createPlanWithTodos, createStandaloneTodo, createPhasePath</done>
</task>

<task type="auto">
  <name>Task 2: Create todos.test.ts with comprehensive coverage</name>
  <files>test/unit/lib/todos.test.ts</files>
  <action>
Create test file for todos.js:

```typescript
// test/unit/lib/todos.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { getCollection } from 'astro:content';
import { mockContentEntry } from '../../setup.js';
import { createPlanWithTodos, createStandaloneTodo } from '../../fixtures/todo-samples.js';

describe('todos.js', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('getInlineTodos', () => {
    it('should extract unchecked todos from PLAN.md', async () => {
      const planFixture = createPlanWithTodos({
        phase: '08-test-infrastructure',
        plan: '01',
        todos: [
          { text: 'Task one', checked: false },
          { text: 'Task two', checked: true },
          { text: 'Task three', checked: false }
        ]
      });

      vi.mocked(getCollection).mockResolvedValue([planFixture]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos).toHaveLength(3);
      expect(todos.filter(t => !t.checked)).toHaveLength(2);
      expect(todos.filter(t => t.checked)).toHaveLength(1);
    });

    it('should extract area from plan file path', async () => {
      const planFixture = createPlanWithTodos({
        phase: '06-prettier-rendering',
        plan: '01',
        todos: [{ text: 'Test task', checked: false }]
      });

      vi.mocked(getCollection).mockResolvedValue([planFixture]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos[0].area).toBe('prettier-rendering');
    });

    it('should handle PLAN.md with no checkboxes', async () => {
      const planFixture = mockContentEntry(
        'phases/01-test/01-01-PLAN',
        '## Tasks\n\nNo checkboxes here'
      );

      vi.mocked(getCollection).mockResolvedValue([planFixture]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos).toHaveLength(0);
    });
  });

  describe('getStandaloneTodos', () => {
    it('should extract todos from todos/pending/*.md', async () => {
      const standaloneFixture = createStandaloneTodo({
        filename: '2026-01-27-add-tests',
        title: 'Add unit tests for parsers',
        area: 'testing',
        created: '2026-01-27T10:00:00Z'
      });

      vi.mocked(getCollection).mockResolvedValue([standaloneFixture]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos).toHaveLength(1);
      expect(todos[0].title).toBe('Add unit tests for parsers');
      expect(todos[0].area).toBe('testing');
      expect(todos[0].source).toBe('standalone');
      expect(todos[0].checked).toBe(false);
    });

    it('should use default area when not specified', async () => {
      const standaloneFixture = mockContentEntry(
        'todos/pending/2026-01-27-test',
        '',
        { title: 'Test todo' }  // No area
      );

      vi.mocked(getCollection).mockResolvedValue([standaloneFixture]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos[0].area).toBe('general');
    });
  });

  describe('getTodos', () => {
    it('should combine standalone and inline todos', async () => {
      const standalone = createStandaloneTodo({
        filename: '2026-01-27-standalone',
        title: 'Standalone task',
        area: 'testing'
      });

      const inline = createPlanWithTodos({
        phase: '08-test',
        plan: '01',
        todos: [{ text: 'Inline task', checked: false }]
      });

      vi.mocked(getCollection).mockResolvedValue([standalone, inline]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos).toHaveLength(2);
      expect(todos.some(t => t.source === 'standalone')).toBe(true);
      expect(todos.some(t => t.source.includes('PLAN'))).toBe(true);
    });

    it('should sort unchecked before checked', async () => {
      const plan = createPlanWithTodos({
        phase: '01-test',
        plan: '01',
        todos: [
          { text: 'Checked first', checked: true },
          { text: 'Unchecked', checked: false }
        ]
      });

      vi.mocked(getCollection).mockResolvedValue([plan]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos[0].checked).toBe(false);
      expect(todos[1].checked).toBe(true);
    });

    it('should sort by area then by date', async () => {
      const todo1 = createStandaloneTodo({
        filename: '2026-01-26-first',
        title: 'Older testing todo',
        area: 'testing',
        created: '2026-01-26T10:00:00Z'
      });
      const todo2 = createStandaloneTodo({
        filename: '2026-01-27-second',
        title: 'Newer testing todo',
        area: 'testing',
        created: '2026-01-27T10:00:00Z'
      });
      const todo3 = createStandaloneTodo({
        filename: '2026-01-27-general',
        title: 'General todo',
        area: 'general',
        created: '2026-01-27T10:00:00Z'
      });

      vi.mocked(getCollection).mockResolvedValue([todo1, todo2, todo3]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      // Should be sorted: general first (alphabetically), then testing
      // Within testing: newer first (by date descending)
      expect(todos[0].area).toBe('general');
      expect(todos[1].title).toBe('Newer testing todo');
      expect(todos[2].title).toBe('Older testing todo');
    });

    it('should return empty array when no todos exist', async () => {
      vi.mocked(getCollection).mockResolvedValue([]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos).toEqual([]);
    });
  });

  describe('deriveAreaFromPath', () => {
    it('should extract area from standard phase path', async () => {
      const plan = mockContentEntry(
        'phases/06-prettier-rendering/06-01-PLAN',
        '- [ ] Test'
      );

      vi.mocked(getCollection).mockResolvedValue([plan]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos[0].area).toBe('prettier-rendering');
    });

    it('should return general for non-phase paths', async () => {
      const plan = mockContentEntry(
        'custom/path/PLAN',
        '- [ ] Test'
      );

      vi.mocked(getCollection).mockResolvedValue([plan]);

      const { getTodos } = await import('../../../src/lib/todos.js');
      const todos = await getTodos();

      expect(todos[0].area).toBe('general');
    });
  });
});
```
  </action>
  <verify>`npm test -- todos.test.ts` - all tests pass</verify>
  <done>todos.test.ts has 10+ passing tests covering inline, standalone, and combined todo extraction</done>
</task>

</tasks>

<verification>
1. `npm test -- todos.test.ts` passes all tests
2. `npm run coverage` shows >80% coverage for todos.js
3. Tests cover inline checkboxes, standalone todos, sorting, and edge cases
</verification>

<success_criteria>
- getTodos correctly combines inline and standalone todos
- getInlineTodos parses checkboxes from PLAN.md files
- getStandaloneTodos reads from todos/pending/*.md
- Sorting works: unchecked first, then by area, then by date
- Edge cases (empty, no checkboxes) handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/09-parsing-tests/09-02-SUMMARY.md`
</output>
