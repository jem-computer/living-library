---
phase: 09-parsing-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/lib/milestones.test.ts
  - test/fixtures/roadmap-samples.ts
autonomous: true

must_haves:
  truths:
    - "getMilestones returns correct structure from sample ROADMAP.md"
    - "parseMilestoneHeader extracts version and name"
    - "parsePhases handles both header format and checkbox format"
    - "Archived milestones are included and sorted correctly"
  artifacts:
    - path: "test/unit/lib/milestones.test.ts"
      provides: "Comprehensive tests for milestone parsing"
      min_lines: 150
    - path: "test/fixtures/roadmap-samples.ts"
      provides: "Reusable ROADMAP.md fixture builders"
      exports: ["createMilestone", "createPhase"]
  key_links:
    - from: "test/unit/lib/milestones.test.ts"
      to: "src/lib/milestones.js"
      via: "dynamic import after vi.mock"
      pattern: "await import\\(.*milestones\\.js"
---

<objective>
Expand milestone parsing tests to cover edge cases, archived milestones, and sorting logic.

Purpose: Requirement PARSE-01 - Unit tests for getMilestones, parsePhases, parseMilestoneHeader
Output: Extended milestones.test.ts with 10+ test cases and reusable fixture builders
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-parsing-tests/09-RESEARCH.md

# Phase 8 established patterns - continue these:
@test/setup.ts
@test/unit/lib/milestones.test.ts
@src/lib/milestones.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roadmap fixture builders</name>
  <files>test/fixtures/roadmap-samples.ts</files>
  <action>
Create fixture builder functions for ROADMAP.md content:

```typescript
// test/fixtures/roadmap-samples.ts

/**
 * Create a milestone fixture with configurable phases
 */
export function createMilestone(options: {
  version?: string;
  name?: string;
  goal?: string;
  phases?: Array<{
    num: number;
    name: string;
    done?: boolean;
    date?: string;
    goal?: string;
  }>;
}): string {
  const { version = 'v1.0', name = 'Test', goal = 'Test goal', phases = [] } = options;

  const phaseBlocks = phases.map(p => {
    const checkmark = p.done ? ' ✓' : '';
    const completedLine = p.done && p.date ? `\n**Completed:** ${p.date}` : '';
    const goalLine = p.goal ? `\n**Goal:** ${p.goal}` : '';
    return `### Phase ${p.num}: ${p.name}${checkmark}${goalLine}${completedLine}`;
  }).join('\n\n');

  return `# Milestone ${version}: ${name}

**Goal:** ${goal}

${phaseBlocks}`;
}

/**
 * Create a single phase block
 */
export function createPhase(options: {
  num: number;
  name: string;
  done?: boolean;
  date?: string;
  goal?: string;
  dependsOn?: number;
}): string {
  const { num, name, done, date, goal, dependsOn } = options;
  const checkmark = done ? ' ✓' : '';
  const lines = [`### Phase ${num}: ${name}${checkmark}`];
  if (goal) lines.push(`**Goal:** ${goal}`);
  if (dependsOn !== undefined) lines.push(`**Depends on**: Phase ${dependsOn}`);
  if (done && date) lines.push(`**Completed:** ${date}`);
  return lines.join('\n');
}

/**
 * Create archived milestone fixture (for milestones/ folder)
 */
export function createArchivedMilestone(options: {
  version: string;
  name: string;
  shippedDate?: string;
  phases: Array<{ num: number; name: string; date?: string }>;
}): string {
  const { version, name, shippedDate, phases } = options;
  const statusLine = shippedDate ? `**Status:** ✅ SHIPPED ${shippedDate}` : '';

  const phaseBlocks = phases.map(p =>
    `### Phase ${p.num}: ${p.name} ✓\n**Completed:** ${p.date || '2026-01-01'}`
  ).join('\n\n');

  return `# Milestone ${version}: ${name}

${statusLine}

${phaseBlocks}`;
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit test/fixtures/roadmap-samples.ts`</verify>
  <done>Fixture builders exist with createMilestone, createPhase, and createArchivedMilestone</done>
</task>

<task type="auto">
  <name>Task 2: Expand milestones.test.ts coverage</name>
  <files>test/unit/lib/milestones.test.ts</files>
  <action>
Extend the existing milestones.test.ts with comprehensive test cases:

1. **Add imports** for fixture builders at top of file:
   ```typescript
   import { createMilestone, createArchivedMilestone } from '../../fixtures/roadmap-samples.js';
   ```

2. **Add test cases for parseMilestoneHeader:**
   - Should extract version and name from standard header
   - Should extract goal from **Goal:** line
   - Should use fallback values for simple # Title format
   - Should handle missing goal line

3. **Add test cases for parsePhases:**
   - Should parse phases with checkmark (✓) as complete
   - Should parse phases with **Completed:** date as complete
   - Should handle phases without goals gracefully
   - Should sort phases by number (3, 1, 2 -> 1, 2, 3)
   - Should parse legacy checkbox format (- [x] **Phase N: Name**)

4. **Add test cases for getMilestones:**
   - Should return empty array when no roadmap exists
   - Should combine current and archived milestones
   - Should sort milestones by version (newest first: v1.2, v1.1, v1.0)
   - Should mark all-complete milestones as status: 'complete'
   - Should extract shippedDate from archived milestones

5. **Add edge case tests:**
   - Should handle empty ROADMAP.md body
   - Should handle ROADMAP.md with no phases
   - Should handle malformed phase numbers gracefully

Use fixture builders from Task 1. Each test should use vi.mocked(getEntry) and vi.mocked(getCollection) with appropriate fixtures, then dynamic import the module.

Pattern from existing tests:
```typescript
vi.mocked(getEntry).mockResolvedValue(mockContentEntry('roadmap', fixtureBody));
vi.mocked(getCollection).mockResolvedValue([...archivedFixtures]);
const { getMilestones } = await import('../../../src/lib/milestones.js');
```
  </action>
  <verify>`npm test -- milestones.test.ts` - all tests pass, no skipped tests</verify>
  <done>milestones.test.ts has 10+ passing tests covering happy path, edge cases, and archived milestones</done>
</task>

</tasks>

<verification>
1. `npm test -- milestones.test.ts` passes all tests
2. `npm run coverage` shows improved coverage for milestones.js (target: >80% lines)
3. Fixture builders are importable and type-correct
</verification>

<success_criteria>
- getMilestones returns correct structure from sample ROADMAP.md
- parseMilestoneHeader extracts version and name correctly
- parsePhases handles both header format and checkbox format
- Archived milestones are included and sorted by version
- Edge cases (empty, malformed) handled gracefully without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/09-parsing-tests/09-01-SUMMARY.md`
</output>
