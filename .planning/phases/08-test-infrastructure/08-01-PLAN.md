---
phase: 08-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - test/setup.ts
  - test/fixtures/planning/ROADMAP.md
  - test/unit/lib/milestones.test.ts
autonomous: true

must_haves:
  truths:
    - "`npm test` runs vitest and exits with status 0"
    - "At least one test passes verifying setup works"
    - "`npm run coverage` generates HTML and text coverage reports"
    - "Test utilities exist for mocking astro:content"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with Astro integration"
      contains: "getViteConfig"
    - path: "test/setup.ts"
      provides: "Test setup and content collection mock utilities"
      exports: ["mockContentEntry", "mockCollection"]
    - path: "test/unit/lib/milestones.test.ts"
      provides: "First passing test validating setup"
      min_lines: 20
    - path: "test/fixtures/planning/ROADMAP.md"
      provides: "Test fixture for milestone parsing"
  key_links:
    - from: "vitest.config.ts"
      to: "test/setup.ts"
      via: "setupFiles configuration"
      pattern: "setupFiles.*setup"
    - from: "test/unit/lib/milestones.test.ts"
      to: "src/lib/milestones.js"
      via: "imports parseMilestoneHeader"
      pattern: "import.*milestones"
---

<objective>
Set up vitest testing infrastructure with coverage reporting and create the first passing test.

Purpose: Establish testing foundation for v1.2 milestone (testing & robustness)
Output: Working test command, coverage reports, content collection mock utilities, first passing test
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-test-infrastructure/08-RESEARCH.md
@src/lib/milestones.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vitest and configure test infrastructure</name>
  <files>
    package.json
    vitest.config.ts
    test/setup.ts
  </files>
  <action>
1. Install dev dependencies:
   ```bash
   npm install -D vitest @vitest/coverage-v8 happy-dom
   ```

2. Add test scripts to package.json:
   ```json
   "scripts": {
     "test": "vitest run",
     "test:watch": "vitest",
     "test:ui": "vitest --ui",
     "coverage": "vitest run --coverage"
   }
   ```

3. Create vitest.config.ts using Astro's getViteConfig helper:
   ```typescript
   /// <reference types="vitest/config" />
   import { getViteConfig } from 'astro/config';

   export default getViteConfig({
     test: {
       globals: true,
       environment: 'happy-dom',
       include: ['test/**/*.test.ts'],
       setupFiles: ['./test/setup.ts'],
       coverage: {
         provider: 'v8',
         reporter: ['text', 'json', 'html'],
         reportsDirectory: './coverage',
         include: ['src/**/*.{ts,js}'],
         exclude: [
           '**/*.test.ts',
           '**/*.d.ts',
           '**/node_modules/**',
           '**/dist/**'
         ]
       }
     }
   });
   ```

4. Create test/setup.ts with content collection mock utilities:
   ```typescript
   import { vi, beforeEach } from 'vitest';

   // Mock astro:content module
   vi.mock('astro:content', () => ({
     getEntry: vi.fn(),
     getCollection: vi.fn(),
     defineCollection: vi.fn(),
     z: {
       object: vi.fn(),
       string: vi.fn(),
       array: vi.fn()
     }
   }));

   // Reset mocks before each test
   beforeEach(() => {
     vi.clearAllMocks();
   });

   /**
    * Create a mock content entry for testing
    * @param id - Entry ID (e.g., 'roadmap')
    * @param body - Markdown body content
    * @param data - Optional frontmatter data
    */
   export function mockContentEntry(id: string, body: string, data: Record<string, unknown> = {}) {
     return {
       id,
       body,
       data,
       collection: 'planning',
       render: vi.fn()
     };
   }

   /**
    * Create a mock collection for testing
    * @param entries - Array of entries returned by getCollection
    */
   export function mockCollection(entries: ReturnType<typeof mockContentEntry>[]) {
     return entries;
   }
   ```

5. Add to .gitignore (if not already there):
   ```
   coverage/
   ```
  </action>
  <verify>
    Run `npm test` - should output "No test files found" (expected, no tests yet)
    Run `npm run coverage` - should show coverage config is valid
    Check vitest.config.ts exists and imports getViteConfig
    Check test/setup.ts exists and exports mockContentEntry
  </verify>
  <done>
    - vitest, @vitest/coverage-v8, happy-dom installed as devDependencies
    - package.json has test, test:watch, test:ui, coverage scripts
    - vitest.config.ts created with Astro integration
    - test/setup.ts created with mock utilities
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test fixture and first passing test</name>
  <files>
    test/fixtures/planning/ROADMAP.md
    test/unit/lib/milestones.test.ts
  </files>
  <action>
1. Create test fixture directory and sample ROADMAP.md:
   ```bash
   mkdir -p test/fixtures/planning
   mkdir -p test/unit/lib
   ```

2. Create test/fixtures/planning/ROADMAP.md with realistic test data:
   ```markdown
   # Milestone v1.0: Foundation

   **Goal:** Establish core infrastructure

   ## Phases

   ### Phase 1: Setup
   **Goal:** Project scaffolding
   **Completed:** 2026-01-20

   ### Phase 2: Core Features
   **Goal:** Build main functionality

   ---

   ## Progress

   | Phase | Plans Complete | Status | Completed |
   |-------|----------------|--------|-----------|
   | 1. Setup | 2/2 | Complete | 2026-01-20 |
   | 2. Core Features | 0/3 | In Progress | - |
   ```

3. Create test/unit/lib/milestones.test.ts:
   ```typescript
   import { describe, it, expect, vi, beforeEach } from 'vitest';
   import { getEntry, getCollection } from 'astro:content';
   import { mockContentEntry } from '../../setup.js';

   // Import the functions we want to test
   // Note: We need to test the pure parsing functions
   // The exported getMilestones uses astro:content which we mock

   describe('milestones.js', () => {
     describe('parseMilestoneHeader', () => {
       // We'll test by calling getMilestones with mocked content
       it('should parse milestone version and name from header', async () => {
         const mockBody = `# Milestone v1.2: Test Infrastructure

   **Goal:** Testing foundation exists`;

         // Mock getEntry to return our test data
         vi.mocked(getEntry).mockResolvedValue(
           mockContentEntry('roadmap', mockBody)
         );
         vi.mocked(getCollection).mockResolvedValue([]);

         // Import after mocking
         const { getMilestones } = await import('../../../src/lib/milestones.js');
         const milestones = await getMilestones();

         expect(milestones).toHaveLength(1);
         expect(milestones[0].version).toBe('v1.2');
         expect(milestones[0].name).toBe('Test Infrastructure');
       });
     });

     describe('parsePhases', () => {
       it('should parse phases from header format', async () => {
         const mockBody = `# Milestone v1.0: Foundation

   ### Phase 1: Setup
   **Goal:** Project scaffolding
   **Completed:** 2026-01-20

   ### Phase 2: Core Features
   **Goal:** Build main functionality`;

         vi.mocked(getEntry).mockResolvedValue(
           mockContentEntry('roadmap', mockBody)
         );
         vi.mocked(getCollection).mockResolvedValue([]);

         const { getMilestones } = await import('../../../src/lib/milestones.js');
         const milestones = await getMilestones();

         expect(milestones[0].phases).toHaveLength(2);
         expect(milestones[0].phases[0].complete).toBe(true);
         expect(milestones[0].phases[0].completedDate).toBe('2026-01-20');
         expect(milestones[0].phases[1].complete).toBe(false);
       });

       it('should mark milestone as active when phases incomplete', async () => {
         const mockBody = `# Milestone v1.0: Test

   ### Phase 1: Done
   **Completed:** 2026-01-20

   ### Phase 2: In Progress`;

         vi.mocked(getEntry).mockResolvedValue(
           mockContentEntry('roadmap', mockBody)
         );
         vi.mocked(getCollection).mockResolvedValue([]);

         const { getMilestones } = await import('../../../src/lib/milestones.js');
         const milestones = await getMilestones();

         expect(milestones[0].active).toBe(true);
         expect(milestones[0].status).toBe('active');
       });
     });
   });
   ```

4. Run tests to verify setup:
   ```bash
   npm test
   ```
  </action>
  <verify>
    Run `npm test` - should show 3 passing tests
    Run `npm run coverage` - should generate coverage report in ./coverage
    Check coverage/index.html exists after running coverage
  </verify>
  <done>
    - test/fixtures/planning/ROADMAP.md created with sample data
    - test/unit/lib/milestones.test.ts created with 3 tests
    - All tests pass when running `npm test`
    - Coverage report generates to ./coverage directory
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test runner works:**
   ```bash
   npm test
   ```
   Expected: "3 passed" (or similar), exit code 0

2. **Coverage report generates:**
   ```bash
   npm run coverage
   ls coverage/
   ```
   Expected: text summary in terminal, coverage/ directory contains index.html

3. **Mock utilities available:**
   ```bash
   grep -l "mockContentEntry" test/setup.ts
   grep -l "import.*setup" test/unit/lib/milestones.test.ts
   ```
   Expected: Files exist and contain expected patterns

4. **Vitest config uses Astro integration:**
   ```bash
   grep "getViteConfig" vitest.config.ts
   ```
   Expected: Pattern found
</verification>

<success_criteria>
- `npm test` exits with code 0 and shows passing tests
- `npm run coverage` generates HTML report in ./coverage
- test/setup.ts exports mockContentEntry and mockCollection utilities
- At least one test exercises the mock utilities successfully
- Requirements TEST-01, TEST-02, TEST-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-infrastructure/08-01-SUMMARY.md`
</output>
