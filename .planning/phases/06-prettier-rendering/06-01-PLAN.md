---
phase: 06-prettier-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/remark-gsd-links.js
autonomous: true

must_haves:
  truths:
    - "@.planning/ROADMAP.md text transforms to clickable link"
    - "@/Users/path/file.md text transforms to styled external reference"
    - "Links don't break when text has surrounding formatting"
  artifacts:
    - path: "src/plugins/remark-gsd-links.js"
      provides: "Remark plugin for @path transformations"
      exports: ["remarkGsdLinks"]
      min_lines: 30
  key_links:
    - from: "src/plugins/remark-gsd-links.js"
      to: "mdast-util-find-and-replace"
      via: "import"
      pattern: "findAndReplace"
---

<objective>
Create remark plugin that transforms @path references in markdown text.

Purpose: RENDER-01 and RENDER-02 require @path syntax to render as links/indicators without changing source files
Output: src/plugins/remark-gsd-links.js - a remark plugin that uses mdast-util-find-and-replace
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-prettier-rendering/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install mdast-util-find-and-replace and unist-builder</name>
  <files>package.json</files>
  <action>
Install the required dependencies for text pattern matching in markdown AST:

```bash
npm install mdast-util-find-and-replace unist-builder
```

These are from the unified ecosystem:
- mdast-util-find-and-replace: Pattern matching in markdown text nodes
- unist-builder (u): Create AST nodes programmatically
  </action>
  <verify>
Run `npm ls mdast-util-find-and-replace unist-builder` - both should show versions installed
  </verify>
  <done>Dependencies added to package.json and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create remark-gsd-links.js plugin</name>
  <files>src/plugins/remark-gsd-links.js</files>
  <action>
Create the remark plugin at `src/plugins/remark-gsd-links.js`:

1. Import findAndReplace from mdast-util-find-and-replace
2. Import u from unist-builder

3. Export function `remarkGsdLinks()` that returns a tree transformer:

Pattern 1 - Internal planning links (RENDER-01):
- Match: `@\.planning\/[^\s\)]+`  (@ followed by .planning/ and non-whitespace/paren chars)
- Transform to: link node with url derived from path
- URL mapping: `@.planning/ROADMAP.md` -> `/roadmap`
- URL mapping: `@.planning/phases/06-prettier-rendering/06-RESEARCH.md` -> `/phases/06-prettier-rendering/06-research`
- Use `.replace('.md', '').toLowerCase()` for slug
- Link text: the original `@.planning/...` text

Pattern 2 - External file references (RENDER-02):
- Match: `@\/[^\s\)]+` (@ followed by absolute path starting with /)
- Transform to: span with class `gsd-external-ref`
- Do NOT make clickable (external paths don't exist in site)
- Visual indicator only (styled via CSS in Plan 03)

Important:
- Use `u('link', { url }, [u('text', match)])` for links
- Use `u('html', '<span class="gsd-external-ref">' + match + '</span>')` for external refs
- Handle edge case: pattern inside code blocks (should NOT transform - findAndReplace handles this automatically as it skips code nodes)
  </action>
  <verify>
Create a test file at `test-plugin.mjs`:

```javascript
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkRehype from 'remark-rehype';
import rehypeStringify from 'rehype-stringify';
import { remarkGsdLinks } from './src/plugins/remark-gsd-links.js';

const md = `
See @.planning/ROADMAP.md for details.
External file: @/Users/jem/.claude/agents/gsd-planner.md
`;

const result = await unified()
  .use(remarkParse)
  .use(remarkGsdLinks)
  .use(remarkRehype, { allowDangerousHtml: true })
  .use(rehypeStringify, { allowDangerousHtml: true })
  .process(md);

console.log(String(result));
```

Run `node test-plugin.mjs` and verify:
- First @path becomes `<a href="/roadmap">@.planning/ROADMAP.md</a>`
- Second @path becomes `<span class="gsd-external-ref">@/Users/jem/.claude/agents/gsd-planner.md</span>`

Delete test file after verification.
  </verify>
  <done>
Plugin transforms @.planning/path to clickable internal links and @/absolute/path to styled external references
  </done>
</task>

</tasks>

<verification>
1. `npm ls mdast-util-find-and-replace unist-builder` shows both installed
2. `src/plugins/remark-gsd-links.js` exists and exports remarkGsdLinks
3. Test script produces correct HTML output for both patterns
</verification>

<success_criteria>
- Plugin file exists at src/plugins/remark-gsd-links.js
- Plugin handles both @.planning/ and @/absolute patterns
- Plugin correctly generates link nodes for internal refs
- Plugin correctly generates span elements for external refs
</success_criteria>

<output>
After completion, create `.planning/phases/06-prettier-rendering/06-01-SUMMARY.md`
</output>
