---
phase: 06-prettier-rendering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/plugins/rehype-gsd-blocks.js
autonomous: true

must_haves:
  truths:
    - "<objective> blocks render with distinct visual styling"
    - "<process> blocks render with distinct visual styling"
    - "<execution_context> blocks render as collapsible sections (default collapsed)"
    - "Other GSD XML blocks have consistent base styling"
  artifacts:
    - path: "src/plugins/rehype-gsd-blocks.js"
      provides: "Rehype plugin for GSD XML block styling"
      exports: ["rehypeGsdBlocks"]
      min_lines: 50
  key_links:
    - from: "src/plugins/rehype-gsd-blocks.js"
      to: "unist-util-visit"
      via: "import"
      pattern: "visit"
    - from: "src/plugins/rehype-gsd-blocks.js"
      to: "hastscript"
      via: "import"
      pattern: "from 'hastscript'"
---

<objective>
Create rehype plugin that transforms GSD XML-like tags into styled HTML elements.

Purpose: RENDER-03 through RENDER-06 require custom XML tags to render beautifully without changing source
Output: src/plugins/rehype-gsd-blocks.js - a rehype plugin that styles GSD semantic blocks
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-prettier-rendering/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rehype dependencies</name>
  <files>package.json</files>
  <action>
Install required dependencies for HTML AST processing:

```bash
npm install rehype-raw unist-util-visit hastscript
```

These are from the unified/rehype ecosystem:
- rehype-raw: Parse raw HTML in markdown (needed for XML-like tags)
- unist-util-visit: Tree traversal with action constants
- hastscript (h): Create HTML elements in hast
  </action>
  <verify>
Run `npm ls rehype-raw unist-util-visit hastscript` - all should show versions installed
  </verify>
  <done>Dependencies added to package.json and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create rehype-gsd-blocks.js plugin</name>
  <files>src/plugins/rehype-gsd-blocks.js</files>
  <action>
Create the rehype plugin at `src/plugins/rehype-gsd-blocks.js`:

1. Import { visit, CONTINUE } from unist-util-visit
2. Import { h } from hastscript

3. Export function `rehypeGsdBlocks()` that returns a tree transformer

Define GSD tag configurations:
```javascript
const gsdTags = {
  'objective': { title: 'Objective', collapsible: false },
  'process': { title: 'Process', collapsible: false },
  'execution_context': { title: 'Execution Context', collapsible: true, defaultClosed: true },
  'success_criteria': { title: 'Success Criteria', collapsible: false },
  'context': { title: 'Context', collapsible: false },
  'tasks': { title: 'Tasks', collapsible: false },
  'task': { title: null, collapsible: false },  // task items don't get headers
  'verification': { title: 'Verification', collapsible: false },
  'output': { title: 'Output', collapsible: false }
};
```

For each matching element:

1. Add base classes: `gsd-block gsd-{tagName}`
2. Add data attribute: `data-gsd-type="{tagName}"`

3. For collapsible blocks (execution_context):
   - Create `<details>` wrapper with class `gsd-collapsible`
   - Create `<summary>` with title text and class `gsd-summary`
   - Move original children into details content div
   - If defaultClosed: don't add `open` attribute
   - Replace original node structure with details/summary

4. For non-collapsible blocks with title:
   - Insert header div at start of children with class `gsd-header`
   - Header contains title text

5. For task elements specifically:
   - Check for `type` attribute and add class `gsd-task-{type}`
   - Check for `name` attribute and render as task header

Important implementation notes:
- Use Object.assign(node, newStructure) to replace node in-place
- Always return CONTINUE from visitor
- Preserve original children content
- Handle missing attributes gracefully with optional chaining
  </action>
  <verify>
Create a test file at `test-rehype.mjs`:

```javascript
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkRehype from 'remark-rehype';
import rehypeRaw from 'rehype-raw';
import rehypeStringify from 'rehype-stringify';
import { rehypeGsdBlocks } from './src/plugins/rehype-gsd-blocks.js';

const md = `
# Test

<objective>
This is the objective text.
</objective>

<execution_context>
This should be collapsed by default.
</execution_context>

<task type="auto">
  <name>Task 1: Do something</name>
  Test task content.
</task>
`;

const result = await unified()
  .use(remarkParse)
  .use(remarkRehype, { allowDangerousHtml: true })
  .use(rehypeRaw)
  .use(rehypeGsdBlocks)
  .use(rehypeStringify)
  .process(md);

console.log(String(result));
```

Run `node test-rehype.mjs` and verify:
- objective has class `gsd-block gsd-objective`
- execution_context wrapped in `<details>` with `<summary>`
- task has class `gsd-task-auto`

Delete test file after verification.
  </verify>
  <done>
Plugin transforms all GSD XML tags with appropriate classes, data attributes, and collapsible wrappers
  </done>
</task>

</tasks>

<verification>
1. `npm ls rehype-raw unist-util-visit hastscript` shows all installed
2. `src/plugins/rehype-gsd-blocks.js` exists and exports rehypeGsdBlocks
3. Test script shows proper class names and details/summary structure
</verification>

<success_criteria>
- Plugin file exists at src/plugins/rehype-gsd-blocks.js
- Plugin handles all defined GSD tags (objective, process, execution_context, etc.)
- execution_context renders as details/summary (collapsed by default)
- All blocks have appropriate CSS classes for styling
</success_criteria>

<output>
After completion, create `.planning/phases/06-prettier-rendering/06-02-SUMMARY.md`
</output>
