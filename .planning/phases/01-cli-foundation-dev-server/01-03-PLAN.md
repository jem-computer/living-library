---
phase: 01-cli-foundation-dev-server
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/cli.js
autonomous: false

must_haves:
  truths:
    - "Running npx living-library starts dev server within 5 seconds"
    - "Dev server auto-detects .planning in current or parent directories"
    - "Startup message shows version number and exact URL"
    - "Server auto-selects free port if 4321 is taken"
    - "File changes in .planning trigger reload notification in terminal"
    - "Ctrl+C gracefully stops server without hanging"
  artifacts:
    - path: "src/cli.js"
      provides: "Complete CLI wiring"
      contains: "startDevServer"
      min_lines: 50
  key_links:
    - from: "src/cli.js"
      to: "src/detect-planning.js"
      via: "detectPlanningDir import"
      pattern: "import.*detectPlanningDir.*detect-planning"
    - from: "src/cli.js"
      to: "src/dev-server.js"
      via: "startDevServer import"
      pattern: "import.*startDevServer.*dev-server"
    - from: "src/cli.js"
      to: "src/ui/spinner.js"
      via: "spinner import"
      pattern: "import.*startSpinner.*spinner"
    - from: "src/cli.js"
      to: "src/scaffold/prompt.js"
      via: "scaffold import"
      pattern: "import.*promptScaffold.*scaffold"
---

<objective>
Wire all modules together into the CLI entry point, completing Phase 1. This plan integrates detection, dev server, UI, and scaffold modules into a cohesive command that handles all user flows.

Purpose: Deliver the complete `npx living-library` experience - from startup to shutdown, including error handling and the scaffold flow.
Output: Fully functional CLI that can be used in any directory with a .planning folder.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-cli-foundation-dev-server/01-CONTEXT.md
@.planning/phases/01-cli-foundation-dev-server/01-01-SUMMARY.md
@.planning/phases/01-cli-foundation-dev-server/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire CLI with all modules</name>
  <files>src/cli.js</files>
  <action>
Update src/cli.js to integrate all modules. Replace the skeleton with:

```javascript
import { parseArgs } from 'node:util';
import { createRequire } from 'node:module';
import { detectPlanningDir } from './detect-planning.js';
import { startDevServer, registerShutdownHandlers, logFileChanges } from './dev-server.js';
import { startSpinner } from './ui/spinner.js';
import { colors, formatStartupBanner } from './ui/colors.js';
import { promptScaffold } from './scaffold/prompt.js';

// Import package.json for version
const require = createRequire(import.meta.url);
const pkg = require('../package.json');

/**
 * CLI entry point
 */
export async function run() {
  const { values } = parseArgs({
    options: {
      verbose: { type: 'boolean', short: 'v', default: false },
      help: { type: 'boolean', short: 'h', default: false },
      version: { type: 'boolean', default: false }
    },
    strict: false,
    allowPositionals: true
  });

  // Handle info flags
  if (values.help) {
    printHelp();
    return;
  }

  if (values.version) {
    console.log(pkg.version);
    return;
  }

  // Main flow: detect .planning and start server
  await startDev(values.verbose);
}

/**
 * Main dev server flow
 * @param {boolean} verbose
 */
async function startDev(verbose) {
  // Step 1: Detect .planning folder
  const detected = await detectPlanningDir();

  if (!detected) {
    // No .planning found - offer to scaffold
    const didScaffold = await promptScaffold();
    if (!didScaffold) {
      process.exit(1);
    }
    // User scaffolded - exit so they can run again
    process.exit(0);
  }

  // Log if found in parent directory (monorepo case)
  if (detected.isMonorepo) {
    console.log(colors.dim(`Found .planning in: ${detected.relative}`));
  }

  // Step 2: Start dev server with spinner
  const spinner = startSpinner('Starting dev server...');

  try {
    const { server, port, url } = await startDevServer({
      root: detected.path,
      verbose
    });

    // Register cleanup before showing success
    registerShutdownHandlers(server);

    // Log file changes
    logFileChanges(server, detected.planningPath);

    // Show success
    spinner.succeed('Ready!');
    console.log('');
    console.log(formatStartupBanner(pkg.version, port, detected.relative));
    console.log('');
    console.log(colors.dim('  Press Ctrl+C to stop'));
    console.log('');

  } catch (error) {
    spinner.fail('Failed to start dev server');
    console.error('');
    console.error(colors.dim(`  ${error.message}`));
    console.error('');

    if (verbose) {
      console.error(error.stack);
    }

    process.exit(1);
  }
}

function printHelp() {
  console.log(`
${colors.bold('living-library')} ${colors.version(pkg.version)}

Documentation viewer for .planning folders

${colors.bold('Usage:')}
  npx living-library [options]

${colors.bold('Options:')}
  -v, --verbose  Show detailed Astro output
  -h, --help     Show this help message
  --version      Show version number

${colors.bold('Examples:')}
  ${colors.dim('# Start dev server in current directory')}
  npx living-library

  ${colors.dim('# Start with verbose output for debugging')}
  npx living-library --verbose

Run in a directory with a .planning folder to start the dev server.
If no .planning folder is found, you'll be prompted to create one.
`);
}
```

Key implementation details:
- Use createRequire to import package.json (avoids ESM JSON import assertion issues across Node versions)
- Register shutdown handlers BEFORE showing success message
- Exit with code 0 after scaffold (user needs to run again to start server)
- Log monorepo detection for clarity
- Spinner stops before prompts (handled by promptScaffold stopping flow)
  </action>
  <verify>
Run: `node bin/living-library.js --help`
  - Shows help with colors
Run: `node bin/living-library.js --version`
  - Shows "0.1.0"
Run: `cd /tmp && node /path/to/living-library/bin/living-library.js`
  - Shows "No .planning directory found" and scaffold prompt
Run: `node bin/living-library.js`
  - From project root (has .planning), starts dev server
  - Shows spinner then "Ready!"
  - Shows banner with version and URL
Run: `Ctrl+C` while server running
  - Server stops gracefully, process exits
  </verify>
  <done>
- src/cli.js integrates all modules: detect-planning, dev-server, spinner, colors, scaffold
- --help shows formatted help text
- --version shows package version
- Running without .planning triggers scaffold prompt
- Running with .planning starts dev server
- Startup message shows version and URL
- Ctrl+C triggers graceful shutdown
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end dev server experience</name>
  <what-built>
Complete living-library CLI that:
- Detects .planning folders (including in parent directories)
- Starts Astro dev server programmatically
- Auto-selects port if 4321 is taken
- Shows minimal Vite-style startup output
- Logs file changes in terminal
- Gracefully shuts down on Ctrl+C
- Offers scaffold prompt when no .planning exists
  </what-built>
  <how-to-verify>
1. **From project root (has .planning):**
   ```bash
   node bin/living-library.js
   ```
   - Should show spinner, then "Ready!" with URL
   - Open http://localhost:4321 in browser (should see Astro page, even if minimal)
   - Edit any .md file in .planning/ - terminal should show "Reloading: filename changed"
   - Press Ctrl+C - should exit cleanly without hanging

2. **Test port fallback:**
   - In one terminal: `node bin/living-library.js`
   - In another terminal: `node bin/living-library.js`
   - Second instance should say "Port 4321 in use, using 4322" and start

3. **Test scaffold flow:**
   ```bash
   cd /tmp
   mkdir test-scaffold && cd test-scaffold
   node /path/to/living-library/bin/living-library.js
   ```
   - Should see "No .planning directory found" warning
   - Prompt to create sample structure
   - Answer yes, enter project name
   - Check `.planning/` folder was created with PROJECT.md, ROADMAP.md, STATE.md

4. **Test verbose mode:**
   ```bash
   node bin/living-library.js --verbose
   ```
   - Should show more detailed Astro output

5. **Test monorepo detection (optional):**
   ```bash
   cd .planning/phases
   node ../../bin/living-library.js
   ```
   - Should show "Found .planning in: ../.planning"
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 1 requirements verified:
- CLI-01: User can run `npx living-library` to start dev server
- CLI-02: Dev server auto-detects `.planning` folder in current directory
- CONT-04: File changes trigger live reload without full page refresh

Success criteria from ROADMAP.md:
1. User runs `npx living-library` and dev server starts within 5 seconds
2. Dev server auto-detects `.planning` folder even in monorepo subdirectories
3. Server displays clear startup message with exact URL and version number
4. Server auto-selects free port if 4321 is taken
5. File changes in `.planning/*.md` trigger live reload without full refresh
</verification>

<success_criteria>
All Phase 1 success criteria met:
- Dev server starts in under 5 seconds
- Works from any subdirectory in a project with .planning
- Shows version and URL on startup
- Handles port conflicts gracefully
- File changes trigger terminal notification (HMR handled by Astro)
- Clean exit on Ctrl+C
- Scaffold flow works when .planning missing
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-foundation-dev-server/01-03-SUMMARY.md`
</output>
