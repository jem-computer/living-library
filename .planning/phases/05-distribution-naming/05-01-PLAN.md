---
phase: 05-distribution-naming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/dev-server.js
  - src/build.js
  - src/content.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Environment variable PLANNING_ROOT is set before Astro starts"
    - "Content collection reads from user's .planning directory, not node_modules"
    - "Fallback to process.cwd() preserves local development workflow"
    - "Package includes all files needed for Astro to run"
  artifacts:
    - path: "src/dev-server.js"
      provides: "Sets process.env.PLANNING_ROOT before calling Astro dev()"
      contains: "process.env.PLANNING_ROOT"
    - path: "src/build.js"
      provides: "Sets process.env.PLANNING_ROOT before calling Astro build()"
      contains: "process.env.PLANNING_ROOT"
    - path: "src/content.config.ts"
      provides: "Reads PLANNING_ROOT env var with fallback"
      contains: "process.env.PLANNING_ROOT"
    - path: "package.json"
      provides: "Files field includes astro.config.mjs and tsconfig.json"
      contains: "astro.config.mjs"
  key_links:
    - from: "src/dev-server.js"
      to: "src/content.config.ts"
      via: "process.env.PLANNING_ROOT"
      pattern: "process\\.env\\.PLANNING_ROOT.*=.*root"
    - from: "src/build.js"
      to: "src/content.config.ts"
      via: "process.env.PLANNING_ROOT"
      pattern: "process\\.env\\.PLANNING_ROOT.*=.*root"
---

<objective>
Fix npm distribution path resolution so content collections load from user's project directory.

Purpose: When installed via npx, the package currently fails because Astro's content.config.ts uses process.cwd() which points to the wrong location. This plan implements the environment variable handoff pattern from research.

Output: Modified CLI files that set PLANNING_ROOT env var, content config that reads it, and updated package.json files field.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-distribution-naming/05-RESEARCH.md

# Source files to modify
@src/dev-server.js
@src/build.js
@src/content.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PLANNING_ROOT env var to CLI commands</name>
  <files>src/dev-server.js, src/build.js</files>
  <action>
In src/dev-server.js, in the startDevServer function, add this line BEFORE the `await dev()` call:

```javascript
// Set environment variable for content.config.ts to read
process.env.PLANNING_ROOT = root;
```

In src/build.js, in the runBuild function, add this line BEFORE the `await build()` call:

```javascript
// Set environment variable for content.config.ts to read
process.env.PLANNING_ROOT = root;
```

The `root` variable is already available in both functions as a parameter. The env var must be set BEFORE Astro is invoked because content.config.ts is evaluated during Astro startup.
  </action>
  <verify>
Read both files and confirm:
1. `process.env.PLANNING_ROOT = root;` appears before the Astro dev()/build() call
2. No syntax errors
  </verify>
  <done>Both CLI files set PLANNING_ROOT environment variable before invoking Astro</done>
</task>

<task type="auto">
  <name>Task 2: Update content.config.ts to read env var</name>
  <files>src/content.config.ts</files>
  <action>
Replace the planningBase constant with:

```typescript
// Use environment variable from CLI (set before Astro starts)
// Fallback to process.cwd() for local development
const planningRoot = process.env.PLANNING_ROOT || process.cwd();
const planningBase = path.join(planningRoot, '.planning');
```

Update the comment above to explain:
```typescript
/**
 * Content collection for .planning markdown files
 *
 * Uses glob loader to discover all markdown files in the .planning directory.
 *
 * Path resolution:
 * - When run via npx: PLANNING_ROOT env var is set by CLI to user's project directory
 * - When run locally: Falls back to process.cwd() for development
 */
```
  </action>
  <verify>
Read src/content.config.ts and confirm:
1. `process.env.PLANNING_ROOT` is used
2. Fallback to `process.cwd()` exists
3. Comment explains the pattern
  </verify>
  <done>Content config reads PLANNING_ROOT with fallback for local dev</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json files field</name>
  <files>package.json</files>
  <action>
Update the "files" field to include all files needed for the package to work when installed:

```json
"files": [
  "bin",
  "src",
  "astro.config.mjs",
  "tsconfig.json"
]
```

Add astro.config.mjs (Astro needs its config file) and tsconfig.json (TypeScript resolution).

Do NOT add dist/ - Astro builds at runtime.
Do NOT add node_modules, .planning, or .git - these are user/development files.
  </action>
  <verify>
Run: `npx npm-packlist` in the project directory and verify the output includes:
- bin/living-library.js
- src/content.config.ts
- astro.config.mjs
- tsconfig.json
  </verify>
  <done>package.json files field includes all required assets for npm publish</done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npm run dev` locally - should still work (fallback path)
2. Run `npx npm-packlist` - should list bin/, src/, astro.config.mjs, tsconfig.json
3. Grep for PLANNING_ROOT in src/ - should appear in dev-server.js, build.js, content.config.ts
</verification>

<success_criteria>
- [ ] dev-server.js sets process.env.PLANNING_ROOT before Astro call
- [ ] build.js sets process.env.PLANNING_ROOT before Astro call
- [ ] content.config.ts reads PLANNING_ROOT with fallback to process.cwd()
- [ ] package.json files field includes astro.config.mjs and tsconfig.json
- [ ] Local development still works (`npm run dev`)
- [ ] npm-packlist shows expected files
</success_criteria>

<output>
After completion, create `.planning/phases/05-distribution-naming/05-01-SUMMARY.md`
</output>
